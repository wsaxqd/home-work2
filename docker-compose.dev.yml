# ============================================================
# å¯è’™ä¹‹å…‰ - å·¥ä¸šçº§å¼€å‘ç¯å¢ƒé…ç½®
# é¡¹ç›®ï¼šqmzg (å¯è’™ä¹‹å…‰)
# æ¶æ„ï¼šå‰ç«¯(React) + åç«¯(Node.js) + æ•°æ®åº“(PostgreSQL)
# ============================================================
#
# ğŸ—ï¸ æ¶æ„è®¾è®¡åŸåˆ™ï¼š
# 1. å†…éƒ¨é€šè¯ï¼ˆæ˜¾å¼ç½‘ç»œï¼‰- æœåŠ¡é€šè¿‡æœåŠ¡åé€šä¿¡ï¼Œç½‘ç»œéš”ç¦»å®‰å…¨
# 2. ä¾èµ–ä¿æŠ¤åŒºï¼ˆåŒ¿åå·ï¼‰- é˜²æ­¢æœ¬åœ°ç©ºç›®å½•è¦†ç›–é•œåƒå†…çš„ node_modules
# 3. æ•°æ®å®‰å…¨ï¼ˆæŒä¹…åŒ–ï¼‰- æ•°æ®åº“ä½¿ç”¨å‘½åå·ï¼Œé‡å¯ä¸ä¸¢å¤±æ•°æ®
# 4. å˜é‡å‰¥ç¦»ï¼ˆå®‰å…¨ï¼‰- æ‰€æœ‰æ•æ„Ÿä¿¡æ¯é€šè¿‡ .env æ–‡ä»¶å¼•ç”¨
#
# ============================================================

version: '3.8'

# ==================== æœåŠ¡å®šä¹‰ ====================
services:

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ PostgreSQL æ•°æ®åº“æœåŠ¡                                     â”‚
  # â”‚ - ä¸“ç”¨å‘½åå·æŒä¹…åŒ–æ•°æ®                                     â”‚
  # â”‚ - å¥åº·æ£€æŸ¥ç¡®ä¿æœåŠ¡å¯ç”¨                                     â”‚
  # â”‚ - æ‰€æœ‰é…ç½®é€šè¿‡ç¯å¢ƒå˜é‡æ³¨å…¥                                 â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  postgres:
    image: postgres:15-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-qmzg}-postgres-dev
    restart: unless-stopped

    # ğŸ” ç¯å¢ƒå˜é‡ï¼ˆä» .env æ–‡ä»¶è¯»å–ï¼‰
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
      # æ€§èƒ½ä¼˜åŒ–å‚æ•°
      POSTGRES_SHARED_BUFFERS: ${DB_SHARED_BUFFERS:-128MB}
      POSTGRES_MAX_CONNECTIONS: ${DB_MAX_CONNECTIONS:-100}

    # ğŸŒ ç«¯å£æ˜ å°„ï¼ˆä¸»æœº:å®¹å™¨ï¼‰
    ports:
      - "${DB_PORT:-5432}:5432"

    # ğŸ’¾ æ•°æ®æŒä¹…åŒ–ï¼ˆå‘½åå·ï¼‰
    volumes:
      # ã€åŸåˆ™3: æ•°æ®å®‰å…¨ã€‘ä½¿ç”¨å‘½åå·æŒä¹…åŒ–æ•°æ®åº“æ•°æ®
      - postgres-data-dev:/var/lib/postgresql/data
      # å¯é€‰ï¼šåˆå§‹åŒ–è„šæœ¬ç›®å½•
      # - ./server/migrations:/docker-entrypoint-initdb.d:ro

    # âœ… å¥åº·æ£€æŸ¥ï¼ˆç¡®ä¿æ•°æ®åº“å®Œå…¨å¯åŠ¨ï¼‰
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

    # ğŸ”— ç½‘ç»œè¿æ¥
    # ã€åŸåˆ™1: å†…éƒ¨é€šè¯ã€‘è¿æ¥åˆ°æ˜¾å¼å‘½åçš„å†…éƒ¨ç½‘ç»œ
    networks:
      - qmzg-internal-network

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ åç«¯ Node.js æœåŠ¡                                         â”‚
  # â”‚ - ä»£ç æŒ‚è½½ + åŒ¿åå·ä¿æŠ¤ä¾èµ–                                â”‚
  # â”‚ - çƒ­é‡è½½å¼€å‘æ¨¡å¼                                          â”‚
  # â”‚ - é€šè¿‡æœåŠ¡å "postgres" è®¿é—®æ•°æ®åº“                         â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
      target: development
      args:
        NODE_VERSION: ${NODE_VERSION:-18-alpine}

    image: ${COMPOSE_PROJECT_NAME:-qmzg}-server:dev
    container_name: ${COMPOSE_PROJECT_NAME:-qmzg}-server-dev
    restart: unless-stopped

    # ğŸ” ç¯å¢ƒå˜é‡ï¼ˆä» .env æ–‡ä»¶è¯»å–ï¼‰
    environment:
      # è¿è¡Œç¯å¢ƒ
      NODE_ENV: development
      PORT: ${SERVER_PORT:-3000}

      # ã€åŸåˆ™1: å†…éƒ¨é€šè¯ã€‘æ•°æ®åº“ä¸»æœºä½¿ç”¨æœåŠ¡åï¼ˆå†…éƒ¨åŸŸåï¼‰
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}

      # JWT é…ç½®
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}

      # Dify AI é…ç½®
      DIFY_API_URL: ${DIFY_API_URL}
      DIFY_CHAT_APP_KEY: ${DIFY_CHAT_APP_KEY}
      DIFY_STORY_APP_KEY: ${DIFY_STORY_APP_KEY}
      DIFY_EMOTION_APP_KEY: ${DIFY_EMOTION_APP_KEY}

      # CORS é…ç½®
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173}

    # ğŸŒ ç«¯å£æ˜ å°„
    ports:
      - "${SERVER_PORT:-3000}:${SERVER_PORT:-3000}"

    # ğŸ’¾ å·æŒ‚è½½é…ç½®
    volumes:
      # ã€æ ¸å¿ƒé…ç½®ã€‘æœ¬åœ°ä»£ç åŒæ­¥ + ä¾èµ–ä¿æŠ¤
      # æŒ‚è½½æœ¬åœ°ä»£ç ç›®å½•ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰
      - ./server:/app

      # ã€åŸåˆ™2: ä¾èµ–ä¿æŠ¤åŒºã€‘ğŸ”¥ åŒ¿åå·ä¿æŠ¤ node_modules
      # é˜²æ­¢æœ¬åœ°ç©ºçš„ node_modules è¦†ç›–é•œåƒå†…å·²å®‰è£…çš„ä¾èµ–
      - /app/node_modules

      # ã€åŸåˆ™2: ä¾èµ–ä¿æŠ¤åŒºã€‘ä¿æŠ¤ç¼–è¯‘è¾“å‡ºç›®å½•
      - /app/dist

      # ã€åŸåˆ™3: æ•°æ®å®‰å…¨ã€‘ä¸Šä¼ æ–‡ä»¶æŒä¹…åŒ–
      - uploads-data-dev:/app/uploads

    # ğŸ”— ä¾èµ–æœåŠ¡ï¼ˆç­‰å¾…æ•°æ®åº“å¥åº·åå¯åŠ¨ï¼‰
    depends_on:
      postgres:
        condition: service_healthy

    # ğŸ”— ç½‘ç»œè¿æ¥
    # ã€åŸåˆ™1: å†…éƒ¨é€šè¯ã€‘è¿æ¥åˆ°æ˜¾å¼å‘½åçš„å†…éƒ¨ç½‘ç»œ
    networks:
      - qmzg-internal-network

    # ğŸ› å¼€å‘å·¥å…·ï¼ˆæ”¯æŒäº¤äº’å¼è°ƒè¯•ï¼‰
    stdin_open: true
    tty: true

    # ğŸ“Š å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get(`http://localhost:$${process.env.PORT || 3000}/health`, (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ å‰ç«¯ React + Vite æœåŠ¡                                    â”‚
  # â”‚ - ä»£ç æŒ‚è½½ + åŒ¿åå·ä¿æŠ¤ä¾èµ–                                â”‚
  # â”‚ - Vite HMR çƒ­æ¨¡å—æ›¿æ¢                                     â”‚
  # â”‚ - é€šè¿‡æœåŠ¡å "server" è®¿é—®åç«¯ API                         â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  app:
    build:
      context: ./app
      dockerfile: Dockerfile
      target: development
      args:
        NODE_VERSION: 20-alpine  # å‰ç«¯ä½¿ç”¨ Node 20

    image: ${COMPOSE_PROJECT_NAME:-qmzg}-app:dev
    container_name: ${COMPOSE_PROJECT_NAME:-qmzg}-app-dev
    restart: unless-stopped

    # ğŸ” ç¯å¢ƒå˜é‡
    environment:
      NODE_ENV: development
      # ã€åŸåˆ™1: å†…éƒ¨é€šè¯ã€‘API åœ°å€ä½¿ç”¨æœåŠ¡å
      VITE_API_URL: ${VITE_API_URL:-http://localhost:3000}

    # ğŸŒ ç«¯å£æ˜ å°„ï¼ˆVite å¼€å‘æœåŠ¡å™¨ï¼‰
    ports:
      - "${APP_PORT:-5173}:${APP_PORT:-5173}"

    # ğŸ’¾ å·æŒ‚è½½é…ç½®
    volumes:
      # ã€æ ¸å¿ƒé…ç½®ã€‘æœ¬åœ°ä»£ç åŒæ­¥ + ä¾èµ–ä¿æŠ¤
      # æŒ‚è½½æœ¬åœ°ä»£ç ç›®å½•ï¼ˆæ”¯æŒ HMR çƒ­é‡è½½ï¼‰
      - ./app:/app

      # ã€åŸåˆ™2: ä¾èµ–ä¿æŠ¤åŒºã€‘ğŸ”¥ åŒ¿åå·ä¿æŠ¤ node_modules
      # è¿™æ˜¯å…³é”®ï¼é˜²æ­¢æœ¬åœ°ç©ºç›®å½•è¦†ç›–é•œåƒå†…çš„ä¾èµ–
      - /app/node_modules

      # ã€åŸåˆ™2: ä¾èµ–ä¿æŠ¤åŒºã€‘ä¿æŠ¤æ„å»ºè¾“å‡ºç›®å½•
      - /app/dist

    # ğŸ”— ä¾èµ–æœåŠ¡
    depends_on:
      - server

    # ğŸ”— ç½‘ç»œè¿æ¥
    # ã€åŸåˆ™1: å†…éƒ¨é€šè¯ã€‘è¿æ¥åˆ°æ˜¾å¼å‘½åçš„å†…éƒ¨ç½‘ç»œ
    networks:
      - qmzg-internal-network

    # ğŸ› å¼€å‘å·¥å…·
    stdin_open: true
    tty: true

    # ğŸ“Š å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5173/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ Nginx é™æ€æ–‡ä»¶æœåŠ¡                                        â”‚
  # â”‚ - æä¾›æ ¹ç›®å½•çš„ HTML é™æ€æ–‡ä»¶è®¿é—®                           â”‚
  # â”‚ - åªè¯»æŒ‚è½½ï¼Œå®‰å…¨éš”ç¦»                                       â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  nginx:
    image: nginx:alpine
    container_name: ${COMPOSE_PROJECT_NAME:-qmzg}-nginx-dev
    restart: unless-stopped

    # ğŸŒ ç«¯å£æ˜ å°„
    ports:
      - "${NGINX_PORT:-8080}:80"

    # ğŸ’¾ å·æŒ‚è½½ï¼ˆåªè¯»æ¨¡å¼ï¼‰
    volumes:
      # æŒ‚è½½é¡¹ç›®æ ¹ç›®å½•çš„é™æ€ HTML æ–‡ä»¶ï¼ˆåªè¯»ï¼‰
      - ./:/usr/share/nginx/html:ro

    # ğŸ”— ç½‘ç»œè¿æ¥
    networks:
      - qmzg-internal-network

    # ğŸ“Š å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  # â”‚ Redis ç¼“å­˜æœåŠ¡ï¼ˆå¯é€‰ï¼‰                                     â”‚
  # â”‚ - å¼€å‘ç¯å¢ƒç¼“å­˜å’Œä¼šè¯å­˜å‚¨                                   â”‚
  # â”‚ - æ•°æ®æŒä¹…åŒ–ï¼Œé‡å¯ä¸ä¸¢å¤±                                   â”‚
  # â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  # redis:
  #   image: redis:7-alpine
  #   container_name: ${COMPOSE_PROJECT_NAME:-qmzg}-redis-dev
  #   restart: unless-stopped
  #
  #   # ğŸ” Redis é…ç½®ï¼ˆå¯é€‰å¯†ç ä¿æŠ¤ï¼‰
  #   command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-}
  #
  #   # ğŸŒ ç«¯å£æ˜ å°„
  #   ports:
  #     - "${REDIS_PORT:-6379}:6379"
  #
  #   # ğŸ’¾ æ•°æ®æŒä¹…åŒ–
  #   volumes:
  #     - redis-data-dev:/data
  #
  #   # ğŸ”— ç½‘ç»œè¿æ¥
  #   networks:
  #     - qmzg-internal-network
  #
  #   # ğŸ“Š å¥åº·æ£€æŸ¥
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

# ==================== ç½‘ç»œé…ç½® ====================
# ã€åŸåˆ™1: å†…éƒ¨é€šè¯ã€‘æ˜¾å¼åˆ›å»ºå‘½åçš„è™šæ‹Ÿç½‘ç»œ
networks:
  qmzg-internal-network:
    # ç½‘ç»œé©±åŠ¨ç±»å‹
    driver: bridge
    # æ˜¾å¼å‘½åï¼ˆä¾¿äºè¯†åˆ«å’Œç®¡ç†ï¼‰
    name: ${COMPOSE_PROJECT_NAME:-qmzg}-internal-dev-network
    # ç½‘ç»œé…ç½®
    driver_opts:
      com.docker.network.bridge.name: br-qmzg-dev
    # å­ç½‘é…ç½®ï¼ˆå¯é€‰ï¼Œæ˜ç¡® IP èŒƒå›´ï¼‰
    ipam:
      driver: default
      config:
        - subnet: 172.30.0.0/16
          gateway: 172.30.0.1

# ==================== æ•°æ®å·é…ç½® ====================
# ã€åŸåˆ™3: æ•°æ®å®‰å…¨ã€‘æ‰€æœ‰æŒä¹…åŒ–æ•°æ®ä½¿ç”¨å‘½åå·
volumes:
  # PostgreSQL æ•°æ®æŒä¹…åŒ–å·
  postgres-data-dev:
    name: ${COMPOSE_PROJECT_NAME:-qmzg}-postgres-data-dev
    driver: local

  # ä¸Šä¼ æ–‡ä»¶æŒä¹…åŒ–å·
  uploads-data-dev:
    name: ${COMPOSE_PROJECT_NAME:-qmzg}-uploads-data-dev
    driver: local

  # Redis æ•°æ®æŒä¹…åŒ–å·ï¼ˆå¯é€‰ï¼‰
  # redis-data-dev:
  #   name: ${COMPOSE_PROJECT_NAME:-qmzg}-redis-data-dev
  #   driver: local

# ============================================================
# ğŸš€ å¿«é€Ÿå¼€å§‹æŒ‡å—
# ============================================================
#
# 1ï¸âƒ£ å‡†å¤‡å·¥ä½œï¼š
#    cp .env.development.example .env.development
#    vim .env.development  # é…ç½®ç¯å¢ƒå˜é‡
#
# 2ï¸âƒ£ å¯åŠ¨å¼€å‘ç¯å¢ƒï¼š
#    docker-compose -f docker-compose.dev.yml up -d --build
#
# 3ï¸âƒ£ æŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼š
#    docker-compose -f docker-compose.dev.yml ps
#
# 4ï¸âƒ£ æŸ¥çœ‹å®æ—¶æ—¥å¿—ï¼š
#    docker-compose -f docker-compose.dev.yml logs -f
#
# 5ï¸âƒ£ è¿›å…¥å®¹å™¨è°ƒè¯•ï¼š
#    docker exec -it qmzg-server-dev sh
#
# 6ï¸âƒ£ åœæ­¢æ‰€æœ‰æœåŠ¡ï¼š
#    docker-compose -f docker-compose.dev.yml down
#
# 7ï¸âƒ£ åœæ­¢å¹¶åˆ é™¤æ•°æ®ï¼š
#    docker-compose -f docker-compose.dev.yml down -v
#
# ============================================================
# ğŸŒ æœåŠ¡è®¿é—®åœ°å€
# ============================================================
#
# ğŸ“± React å‰ç«¯ï¼ˆVite HMRï¼‰:  http://localhost:5173
# ğŸš€ åç«¯ API æœåŠ¡:           http://localhost:3000
# ğŸ“„ é™æ€ HTML é¡µé¢:          http://localhost:8080
# ğŸ—„ï¸ PostgreSQL æ•°æ®åº“:       localhost:5432
# ğŸ”´ Redis ç¼“å­˜ï¼ˆå¯é€‰ï¼‰:       localhost:6379
#
# ============================================================
# ğŸ” æ¶æ„éªŒè¯
# ============================================================
#
# âœ… ç½‘ç»œéš”ç¦»æµ‹è¯•ï¼š
#    docker network inspect qmzg-internal-dev-network
#
# âœ… ä¾èµ–ä¿æŠ¤éªŒè¯ï¼š
#    docker exec qmzg-server-dev ls -la /app/node_modules
#    ï¼ˆåº”è¯¥çœ‹åˆ°é•œåƒå†…å®‰è£…çš„ä¾èµ–ï¼Œè€Œä¸æ˜¯ç©ºç›®å½•ï¼‰
#
# âœ… æ•°æ®æŒä¹…åŒ–éªŒè¯ï¼š
#    docker volume ls | grep qmzg
#    ï¼ˆåº”è¯¥çœ‹åˆ°å‘½åå·å­˜åœ¨ï¼‰
#
# âœ… å†…éƒ¨é€šä¿¡æµ‹è¯•ï¼š
#    docker exec qmzg-server-dev ping postgres
#    ï¼ˆåº”è¯¥èƒ½ ping é€šæ•°æ®åº“æœåŠ¡ï¼‰
#
# ============================================================

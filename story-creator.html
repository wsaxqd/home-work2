<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIç«¥è¯åˆ¶é€ æœº - å¯è’™ä¹‹å…‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 0;
            position: relative;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #7e57c2 0%, #5c6bc0 100%);
            color: white;
            border-radius: 0 0 20px 20px;
        }
        
        .back-button {
            font-size: 24px;
            cursor: pointer;
        }
        
        .page-title {
            font-size: 20px;
            text-align: center;
            flex: 1;
        }
        
        .main-content {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 140px);
        }
        
        .section-title {
            font-size: 18px;
            margin: 20px 0 15px;
            color: #7e57c2;
            display: flex;
            align-items: center;
        }
        
        .section-title::before {
            content: "";
            display: inline-block;
            width: 5px;
            height: 20px;
            background: #7e57c2;
            margin-right: 10px;
            border-radius: 3px;
        }
        
        /* æ•…äº‹åˆ›ä½œå‘å¯¼æ ·å¼ */
        .wizard-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 2px solid #f3e5f5;
        }
        
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
        }
        
        .wizard-steps::before {
            content: "";
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }
        
        .wizard-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .step-circle {
            width: 30px;
            height: 30px;
            background: #e0e0e0;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .wizard-step.active .step-circle {
            background: #7e57c2;
        }
        
        .wizard-step.completed .step-circle {
            background: #5c6bc0;
        }
        
        .step-label {
            font-size: 12px;
            color: #666;
        }
        
        .wizard-step.active .step-label {
            color: #7e57c2;
            font-weight: bold;
        }
        
        .wizard-content {
            min-height: 200px;
        }
        
        /* æ•…äº‹ä¸»é¢˜é€‰æ‹©æ ·å¼ */
        .theme-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .theme-card {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid transparent;
        }
        
        .theme-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .theme-card.selected {
            border-color: #7e57c2;
            background: #f3e5f5;
        }
        
        .theme-icon {
            font-size: 30px;
            margin-bottom: 10px;
            color: #7e57c2;
        }
        
        .theme-name {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .theme-desc {
            font-size: 12px;
            color: #666;
        }
        
        /* è§’è‰²è®¾ç½®æ ·å¼ */
        .character-section {
            display: none;
        }
        
        .character-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-size: 14px;
            margin-bottom: 8px;
            color: #333;
        }
        
        .form-input {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
        }
        
        .form-input:focus {
            border-color: #7e57c2;
        }
        
        .form-select {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            background: white;
        }
        
        /* æ•…äº‹é¢„è§ˆæ ·å¼ */
        .preview-section {
            display: none;
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .preview-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #7e57c2;
            text-align: center;
        }
        
        .story-preview {
            background: white;
            border-radius: 10px;
            padding: 15px;
            min-height: 200px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }
        
        .story-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }
        
        .loading-animation {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3e5f5;
            border-top: 4px solid #7e57c2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        .loading-text {
            font-size: 14px;
            color: #666;
        }
        
        /* æ•…äº‹ç¼–è¾‘å™¨æ ·å¼ */
        .editor-section {
            display: none;
        }
        
        .editor-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .toolbar-btn {
            padding: 8px 12px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.3s;
        }
        
        .toolbar-btn:hover {
            background: #e0e0e0;
        }
        
        .editor-area {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            outline: none;
        }
        
        .editor-area:focus {
            border-color: #7e57c2;
        }
        
        /* æ§åˆ¶æŒ‰é’®æ ·å¼ */
        .control-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, background 0.3s;
        }
        
        .btn:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #7e57c2;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #5c6bc0;
            transform: scale(1.03);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
            transform: scale(1.03);
        }
        
        /* åº•éƒ¨å¯¼èˆªæ ·å¼ */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 15px 0;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 480px;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 5px;
            color: #999;
        }
        
        .nav-item.active .nav-icon {
            color: #7e57c2;
        }
        
        .nav-text {
            font-size: 12px;
            color: #999;
        }
        
        .nav-item.active .nav-text {
            color: #7e57c2;
            font-weight: bold;
        }
        
        /* åŠ¨ç”» */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 480px) {
            .container {
                padding-bottom: 70px;
            }
            
            .theme-grid {
                grid-template-columns: 1fr;
            }
            
            .control-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="back-button" onclick="goBack()">â†</div>
            <div class="page-title">AIç«¥è¯åˆ¶é€ æœº</div>
            <div style="width: 24px;"></div> <!-- å ä½ä¿æŒå¯¹ç§° -->
        </div>
        
        <div class="main-content">
            <div class="wizard-section">
                <div class="wizard-steps">
                    <div class="wizard-step active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">é€‰æ‹©ä¸»é¢˜</div>
                    </div>
                    <div class="wizard-step" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">è®¾ç½®è§’è‰²</div>
                    </div>
                    <div class="wizard-step" id="step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">ç”Ÿæˆæ•…äº‹</div>
                    </div>
                    <div class="wizard-step" id="step4">
                        <div class="step-circle">4</div>
                        <div class="step-label">ç¼–è¾‘å®Œå–„</div>
                    </div>
                </div>
                
                <div class="wizard-content">
                    <!-- æ­¥éª¤1: é€‰æ‹©ä¸»é¢˜ -->
                    <div id="step1-content" class="step-content">
                        <div class="section-title">é€‰æ‹©æ•…äº‹ä¸»é¢˜</div>
                        <div class="theme-grid">
                            <div class="theme-card" onclick="selectTheme(this, 'adventure')">
                                <div class="theme-icon">ğŸš€</div>
                                <div class="theme-name">å¥‡å¹»å†’é™©</div>
                                <div class="theme-desc">æ¢ç´¢æœªçŸ¥çš„ç¥ç§˜ä¸–ç•Œ</div>
                            </div>
                            <div class="theme-card" onclick="selectTheme(this, 'friendship')">
                                <div class="theme-icon">ğŸ¤</div>
                                <div class="theme-name">å‹è°Šé­”æ³•</div>
                                <div class="theme-desc">å…³äºå‹æƒ…å’Œåˆä½œçš„æ•…äº‹</div>
                            </div>
                            <div class="theme-card" onclick="selectTheme(this, 'science')">
                                <div class="theme-icon">ğŸ”¬</div>
                                <div class="theme-name">ç§‘å­¦æ¢ç´¢</div>
                                <div class="theme-desc">ç”¨ç§‘å­¦è§£å†³éš¾é¢˜</div>
                            </div>
                            <div class="theme-card" onclick="selectTheme(this, 'animal')">
                                <div class="theme-icon">ğŸ¾</div>
                                <div class="theme-name">åŠ¨ç‰©ç‹å›½</div>
                                <div class="theme-desc">åŠ¨ç‰©ä»¬çš„å¥‡å¦™æ•…äº‹</div>
                            </div>
                            <div class="theme-card" onclick="selectTheme(this, 'robot')">
                                <div class="theme-icon">ğŸ¤–</div>
                                <div class="theme-name">AIä¼™ä¼´</div>
                                <div class="theme-desc">ä¸æ™ºèƒ½æœºå™¨äººçš„æ•…äº‹</div>
                            </div>
                            <div class="theme-card" onclick="selectTheme(this, 'custom')">
                                <div class="theme-icon">âœ¨</div>
                                <div class="theme-name">è‡ªå®šä¹‰</div>
                                <div class="theme-desc">åˆ›é€ ç‹¬ç‰¹çš„æ•…äº‹</div>
                            </div>
                        </div>
                        
                        <div class="control-buttons">
                            <button class="btn btn-secondary" onclick="goBack()">è¿”å›</button>
                            <button class="btn btn-primary" id="step1-next" onclick="nextStep(2)" disabled>ä¸‹ä¸€æ­¥</button>
                        </div>
                    </div>
                    
                    <!-- æ­¥éª¤2: è®¾ç½®è§’è‰² -->
                    <div id="step2-content" class="step-content character-section">
                        <div class="section-title">è®¾ç½®æ•…äº‹è§’è‰²</div>
                        <div class="character-form">
                            <div class="form-group">
                                <label class="form-label">ä¸»è§’åå­—</label>
                                <input type="text" class="form-input" id="main-character" placeholder="ä¾‹å¦‚ï¼šå°å…‰ã€é˜¿æ˜..." oninput="validateStep2()">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ä¸»è§’æ€§æ ¼</label>
                                <select class="form-select" id="character-personality" onchange="validateStep2()">
                                    <option value="">é€‰æ‹©æ€§æ ¼ç‰¹ç‚¹</option>
                                    <option value="brave">å‹‡æ•¢çš„</option>
                                    <option value="curious">å¥½å¥‡çš„</option>
                                    <option value="kind">å–„è‰¯çš„</option>
                                    <option value="smart">èªæ˜çš„</option>
                                    <option value="funny">æœ‰è¶£çš„</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">æ•…äº‹åœ°ç‚¹</label>
                                <input type="text" class="form-input" id="story-location" placeholder="ä¾‹å¦‚ï¼šé­”æ³•æ£®æ—ã€æœªæ¥åŸå¸‚..." oninput="validateStep2()">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ç‰¹åˆ«å…ƒç´ ï¼ˆå¯é€‰ï¼‰</label>
                                <input type="text" class="form-input" id="special-element" placeholder="ä¾‹å¦‚ï¼šä¼šè¯´è¯çš„åŠ¨ç‰©ã€ç¥å¥‡çš„å®çŸ³...">
                            </div>
                        </div>
                        
                        <div class="control-buttons">
                            <button class="btn btn-secondary" onclick="prevStep(1)">ä¸Šä¸€æ­¥</button>
                            <button class="btn btn-primary" id="step2-next" onclick="nextStep(3)" disabled>ä¸‹ä¸€æ­¥</button>
                        </div>
                    </div>
                    
                    <!-- æ­¥éª¤3: ç”Ÿæˆæ•…äº‹ -->
                    <div id="step3-content" class="step-content preview-section">
                        <div class="section-title">AIæ­£åœ¨åˆ›ä½œä½ çš„æ•…äº‹</div>
                        <div class="preview-title" id="story-title">ä½ çš„ä¸“å±ç«¥è¯</div>
                        <div class="story-preview">
                            <div class="loading-animation" id="loading-animation">
                                <div class="spinner"></div>
                                <div class="loading-text">AIæ­£åœ¨åŠªåŠ›åˆ›ä½œä¸­ï¼Œè¯·ç¨å€™...</div>
                            </div>
                            <div class="story-content" id="generated-story" style="display: none;"></div>
                        </div>
                        
                        <div class="control-buttons">
                            <button class="btn btn-secondary" onclick="prevStep(2)">ä¸Šä¸€æ­¥</button>
                            <button class="btn btn-primary" id="step3-next" onclick="nextStep(4)" disabled>ä¸‹ä¸€æ­¥</button>
                        </div>
                    </div>
                    
                    <!-- æ­¥éª¤4: ç¼–è¾‘å®Œå–„ -->
                    <div id="step4-content" class="step-content editor-section">
                        <div class="section-title">ç¼–è¾‘å’Œå®Œå–„æ•…äº‹</div>
                        <div class="editor-toolbar">
                            <button class="toolbar-btn" onclick="formatText('bold')"><b>B</b></button>
                            <button class="toolbar-btn" onclick="formatText('italic')"><i>I</i></button>
                            <button class="toolbar-btn" onclick="insertEmoji('ğŸŒŸ')">ğŸŒŸ æ·»åŠ æ˜Ÿæ˜Ÿ</button>
                            <button class="toolbar-btn" onclick="suggestImprovements()">ğŸ’¡ AIå»ºè®®</button>
                        </div>
                        <textarea class="editor-area" id="story-editor" placeholder="åœ¨è¿™é‡Œç¼–è¾‘å’Œå®Œå–„ä½ çš„æ•…äº‹..."></textarea>
                        
                        <div class="control-buttons">
                            <button class="btn btn-secondary" onclick="prevStep(3)">ä¸Šä¸€æ­¥</button>
                            <button class="btn btn-primary" onclick="saveStory()">ä¿å­˜æ•…äº‹</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bottom-nav">
            <div class="nav-item" onclick="navigateTo('index.html')">
                <div class="nav-icon">ğŸ </div>
                <div class="nav-text">é¦–é¡µ</div>
            </div>
            <div class="nav-item" onclick="navigateTo('explore.html')">
                <div class="nav-icon">ğŸ”</div>
                <div class="nav-text">æ¢ç´¢</div>
            </div>
            <div class="nav-item" onclick="navigateTo('create.html')">
                <div class="nav-icon">ğŸ¨</div>
                <div class="nav-text">åˆ›ä½œ</div>
            </div>
            <div class="nav-item" onclick="navigateTo('mind-garden.html')">
                <div class="nav-icon">ğŸ’</div>
                <div class="nav-text">å¿ƒçµ</div>
            </div>
            <div class="nav-item" onclick="navigateTo('profile.html')">
                <div class="nav-icon">ğŸ‘¤</div>
                <div class="nav-text">æˆ‘çš„</div>
            </div>
        </div>
    </div>

    <script src="navigation-template.js"></script>
    <script>
        // APIé…ç½®
        const API_BASE = 'http://localhost:3000/api';

        // å½“å‰æ­¥éª¤å’Œæ•…äº‹æ•°æ®
        let currentStep = 1;
        let storyData = {
            theme: '',
            mainCharacter: '',
            personality: '',
            location: '',
            specialElement: '',
            storyContent: ''
        };
        
        // åˆå§‹åŒ–å¯¼èˆª
        document.addEventListener('DOMContentLoaded', function() {
            initAppNavigation();
        });
        
        // å¯¼èˆªåŠŸèƒ½
        function goBack() {
            // æ£€æŸ¥æ¥æºé¡µé¢å’Œå†å²è®°å½•
            if (document.referrer && window.history.length > 1) {
                // å¦‚æœæœ‰æœ‰æ•ˆçš„æ¥æºé¡µé¢å’Œå†å²è®°å½•ï¼Œåˆ™è¿”å›ä¸Šä¸€é¡µ
                window.history.back();
            } else {
                // å¦åˆ™ï¼Œå¯¼èˆªåˆ°é¦–é¡µ
                navigateTo('index.html');
            }
        }
        
        // æ­¥éª¤æ§åˆ¶
        function prevStep(step) {
            if (currentStep > 1) {
                currentStep = step;
                updateStepDisplay();
            }
        }
        
        // æ­¥éª¤å¯¼èˆª
        function nextStep(step) {
            // éšè—å½“å‰æ­¥éª¤å†…å®¹
            document.getElementById(`step${currentStep}-content`).style.display = 'none';
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${currentStep}`).classList.add('completed');
            
            // æ˜¾ç¤ºæ–°æ­¥éª¤å†…å®¹
            currentStep = step;
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById(`step${currentStep}-content`).style.display = 'block';
            
            // ç‰¹æ®Šå¤„ç†ï¼šæ­¥éª¤3ç”Ÿæˆæ•…äº‹
            if (step === 3) {
                generateStory();
            }
            
            // ç‰¹æ®Šå¤„ç†ï¼šæ­¥éª¤4åŠ è½½æ•…äº‹åˆ°ç¼–è¾‘å™¨
            if (step === 4) {
                document.getElementById('story-editor').value = storyData.storyContent;
            }
        }
        
        function prevStep(step) {
            // éšè—å½“å‰æ­¥éª¤å†…å®¹
            document.getElementById(`step${currentStep}-content`).style.display = 'none';
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            document.getElementById(`step${currentStep}`).classList.remove('active');
            
            // æ˜¾ç¤ºä¸Šä¸€æ­¥å†…å®¹
            currentStep = step;
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById(`step${currentStep}-content`).style.display = 'block';
        }
        
        // é€‰æ‹©ä¸»é¢˜
        function selectTheme(caller, theme) {
            // æ”¯æŒä¸¤ç§è°ƒç”¨ï¼šselectTheme(theme) æˆ– selectTheme(caller, theme)
            if (typeof theme === 'undefined') {
                theme = caller;
                caller = null;
            }

            // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('selected');
            });

            // è®¾ç½®æ–°çš„é€‰æ‹©
            var targetEl = null;
            if (caller && caller.nodeType) {
                targetEl = caller;
            } else if (typeof event !== 'undefined' && event.target) {
                targetEl = event.target.closest ? event.target.closest('.theme-card') : event.target;
            }

            if (targetEl) targetEl.classList.add('selected');
            storyData.theme = theme;

            // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
            document.getElementById('step1-next').disabled = false;
        }
        
        // éªŒè¯æ­¥éª¤2è¾“å…¥
        function validateStep2() {
            const mainCharacter = document.getElementById('main-character').value;
            const personality = document.getElementById('character-personality').value;
            const location = document.getElementById('story-location').value;
            
            // ä¿å­˜æ•°æ®
            storyData.mainCharacter = mainCharacter;
            storyData.personality = personality;
            storyData.location = location;
            storyData.specialElement = document.getElementById('special-element').value;
            
            // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
            document.getElementById('step2-next').disabled = !(mainCharacter && personality && location);
        }
        
        // ç”Ÿæˆæ•…äº‹
        async function generateStory() {
            const loadingElement = document.getElementById('loading-animation');
            const storyElement = document.getElementById('generated-story');

            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            loadingElement.style.display = 'flex';
            storyElement.style.display = 'none';

            try {
                // æ£€æŸ¥JWT token
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('è¯·å…ˆç™»å½•ï¼');
                    window.location.href = 'login.html';
                    return;
                }

                // æ„å»ºæ•…äº‹ç”Ÿæˆè¯·æ±‚
                const themes = {
                    'adventure': 'å¥‡å¹»å†’é™©',
                    'friendship': 'å‹è°Šé­”æ³•',
                    'science': 'ç§‘å­¦æ¢ç´¢',
                    'animal': 'åŠ¨ç‰©ç‹å›½',
                    'robot': 'AIä¼™ä¼´',
                    'custom': 'è‡ªå®šä¹‰'
                };

                const personalities = {
                    'brave': 'å‹‡æ•¢',
                    'curious': 'å¥½å¥‡',
                    'kind': 'å–„è‰¯',
                    'smart': 'èªæ˜',
                    'funny': 'æœ‰è¶£'
                };

                const prompt = `è¯·ä¸ºå„¿ç«¥åˆ›ä½œä¸€ä¸ª${themes[storyData.theme] || 'å¥‡å¦™'}ä¸»é¢˜çš„ç«¥è¯æ•…äº‹ã€‚
æ•…äº‹èƒŒæ™¯ï¼š${storyData.location}
ä¸»è§’åå­—ï¼š${storyData.mainCharacter}
ä¸»è§’æ€§æ ¼ï¼š${personalities[storyData.personality] || 'ç‰¹åˆ«'}
${storyData.specialElement ? 'ç‰¹æ®Šå…ƒç´ ï¼š' + storyData.specialElement : ''}

è¦æ±‚ï¼š
1. æ•…äº‹è¦é€‚åˆ6-12å²å„¿ç«¥é˜…è¯»
2. å†…å®¹ç§¯æå‘ä¸Šï¼Œä¼ é€’æ­£èƒ½é‡
3. ç¯‡å¹…é€‚ä¸­ï¼Œçº¦300-500å­—
4. æœ‰æ¸…æ™°çš„å¼€å¤´ã€å‘å±•å’Œç»“å±€
5. è¯­è¨€ç”ŸåŠ¨æœ‰è¶£ï¼Œå¯Œæœ‰æƒ³è±¡åŠ›`;

                // è°ƒç”¨AI APIç”Ÿæˆæ•…äº‹
                const response = await fetch(`${API_BASE}/ai/story`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        context: `å„¿ç«¥æ•…äº‹åˆ›ä½œ - ${storyData.mainCharacter}çš„æ•…äº‹`
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.message || 'æ•…äº‹ç”Ÿæˆå¤±è´¥');
                }

                // è·å–AIç”Ÿæˆçš„æ•…äº‹
                const generatedStory = result.data.response || result.data.reply || result.data.story;

                if (!generatedStory) {
                    throw new Error('AIè¿”å›çš„æ•…äº‹å†…å®¹ä¸ºç©º');
                }

                // æ ¼å¼åŒ–æ•…äº‹å†…å®¹
                const formattedStory = formatStoryContent(generatedStory);

                // æ˜¾ç¤ºç”Ÿæˆçš„æ•…äº‹
                loadingElement.style.display = 'none';
                storyElement.style.display = 'block';
                storyElement.innerHTML = formattedStory;

                // ä¿å­˜æ•…äº‹å†…å®¹
                storyData.storyContent = formattedStory;

                // æ›´æ–°æ•…äº‹æ ‡é¢˜
                document.getElementById('story-title').innerText = `${storyData.mainCharacter}çš„${themes[storyData.theme] || 'å¥‡å¦™'}ä¹‹æ—…`;

                // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
                document.getElementById('step3-next').disabled = false;

            } catch (error) {
                console.error('ç”Ÿæˆæ•…äº‹å¤±è´¥:', error);

                // éšè—åŠ è½½åŠ¨ç”»
                loadingElement.style.display = 'none';

                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                storyElement.style.display = 'block';
                storyElement.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e57373;">
                        <p style="font-size: 40px; margin-bottom: 10px;">ğŸ˜”</p>
                        <p style="font-size: 16px; margin-bottom: 10px;">æ•…äº‹ç”Ÿæˆå¤±è´¥</p>
                        <p style="font-size: 14px; color: #666;">${error.message}</p>
                        <button class="btn btn-primary" onclick="generateStory()" style="margin-top: 15px;">é‡æ–°ç”Ÿæˆ</button>
                    </div>
                `;
            }
        }

        // æ ¼å¼åŒ–æ•…äº‹å†…å®¹
        function formatStoryContent(content) {
            // å¦‚æœå†…å®¹å·²ç»åŒ…å«HTMLæ ‡ç­¾ï¼Œç›´æ¥è¿”å›
            if (content.includes('<h3>') || content.includes('<p>')) {
                return content;
            }

            // å¦åˆ™è¿›è¡Œç®€å•çš„æ ¼å¼åŒ–
            let formatted = '';
            const lines = content.split('\n').filter(line => line.trim());

            lines.forEach((line, index) => {
                if (index === 0 && line.length < 50) {
                    // ç¬¬ä¸€è¡Œå¯èƒ½æ˜¯æ ‡é¢˜
                    formatted += `<h3>${line}</h3>`;
                } else {
                    formatted += `<p>${line}</p>`;
                }
            });

            return formatted || `<p>${content}</p>`;
        }
        // æ–‡æœ¬æ ¼å¼åŒ–åŠŸèƒ½
        function formatText(type) {
            const editor = document.getElementById('story-editor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            
            let formattedText = '';
            
            if (type === 'bold') {
                formattedText = `<b>${selectedText}</b>`;
            } else if (type === 'italic') {
                formattedText = `<i>${selectedText}</i>`;
            }
            
            editor.value = editor.value.substring(0, start) + formattedText + editor.value.substring(end);
            storyData.storyContent = editor.value;
        }
        
        // æ’å…¥è¡¨æƒ…ç¬¦å·
        function insertEmoji(emoji) {
            const editor = document.getElementById('story-editor');
            const start = editor.selectionStart;
            
            editor.value = editor.value.substring(0, start) + emoji + editor.value.substring(start);
            storyData.storyContent = editor.value;
        }
        
        // AIæ”¹è¿›å»ºè®®
        function suggestImprovements() {
            alert("AIå»ºè®®ï¼š\n1. å¯ä»¥å¢åŠ æ›´å¤šå¯¹è¯ï¼Œè®©æ•…äº‹æ›´ç”ŸåŠ¨\n2. æ·»åŠ ä¸€äº›æœ‰è¶£çš„ç»†èŠ‚æè¿°\n3. è€ƒè™‘ç»™æ•…äº‹ä¸€ä¸ªæ„å¤–çš„è½¬æŠ˜\n\nè¿™äº›åªæ˜¯å»ºè®®ï¼Œä½ çš„æ•…äº‹å·²ç»å¾ˆæ£’äº†ï¼");
        }
        
        // ä¿å­˜æ•…äº‹
        async function saveStory() {
            // æ›´æ–°æ•…äº‹å†…å®¹
            storyData.storyContent = document.getElementById('story-editor').value;

            if (!storyData.storyContent || storyData.storyContent.trim() === '') {
                alert('æ•…äº‹å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            try {
                // æ£€æŸ¥JWT token
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('è¯·å…ˆç™»å½•ï¼');
                    window.location.href = 'login.html';
                    return;
                }

                // æ˜¾ç¤ºä¿å­˜ä¸­æç¤º
                const saveBtn = event.target;
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'ä¿å­˜ä¸­...';
                saveBtn.disabled = true;

                // è·å–æ•…äº‹æ ‡é¢˜
                const storyTitle = document.getElementById('story-title')?.innerText.trim() || `${storyData.mainCharacter}çš„æ•…äº‹`;

                // å‡†å¤‡ä½œå“æ•°æ®
                const workData = {
                    type: 'story',
                    title: storyTitle,
                    content: storyData.storyContent,
                    metadata: {
                        theme: storyData.theme,
                        mainCharacter: storyData.mainCharacter,
                        personality: storyData.personality,
                        location: storyData.location,
                        specialElement: storyData.specialElement
                    }
                };

                // è°ƒç”¨åç«¯APIä¿å­˜ä½œå“
                const response = await fetch(`${API_BASE}/works`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(workData)
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                }

                // åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
                try {
                    const timestamp = new Date().getTime();
                    const dateStr = new Date().toLocaleDateString('zh-CN').replace(/\//g, '-');

                    const storyDataObj = {
                        id: result.data?.id || timestamp,
                        title: storyTitle,
                        filename: `${storyTitle}_${dateStr}_${timestamp}`,
                        content: storyData.storyContent,
                        genre: storyData.theme || 'general',
                        length: storyData.storyContent.length,
                        timestamp: new Date().toISOString(),
                        type: 'story'
                    };

                    let artworks = JSON.parse(localStorage.getItem('qmzg_artworks') || '[]');
                    artworks.unshift(storyDataObj);

                    if (artworks.length > 20) {
                        artworks = artworks.slice(0, 20);
                    }

                    localStorage.setItem('qmzg_artworks', JSON.stringify(artworks));
                } catch (storageError) {
                    console.warn('localStorageä¿å­˜å¤±è´¥:', storageError);
                    // ä¸å½±å“ä¸»è¦æµç¨‹
                }

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;

                alert("æ•…äº‹å·²æˆåŠŸä¿å­˜ï¼ä½ å¯ä»¥åœ¨'æˆ‘çš„ä½œå“'ä¸­æŸ¥çœ‹å’Œåˆ†äº«å®ƒã€‚");

                // è¿”å›åˆ›ä½œé¡µ
                setTimeout(() => {
                    navigateTo('create.html');
                }, 1500);

            } catch (error) {
                console.error('ä¿å­˜æ•…äº‹å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (event && event.target) {
                    event.target.textContent = 'ä¿å­˜æ•…äº‹';
                    event.target.disabled = false;
                }
            }
        }
        
        // ä¸ºåº•éƒ¨å¯¼èˆªæ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.nav-item').forEach((item) => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€æ­¥
            document.getElementById('step1-content').style.display = 'block';
        });
    </script>
</body>
</html>
# 启蒙之光 - 发布准备清单

## 📋 必须完成项（发布前）

### 1. 数据库配置与迁移 ⚠️ 当前阻塞

#### 1.1 检查 PostgreSQL 服务
```bash
# Windows 检查服务状态
sc query postgresql-x64-14

# 或者检查端口占用
netstat -ano | findstr :5432
netstat -ano | findstr :5433
```

#### 1.2 修正数据库端口配置
当前 `.env` 文件中 `DB_PORT=5433`，但 PostgreSQL 默认端口是 5432。

**选项 A：修改 .env 文件使用标准端口**
```bash
DB_PORT=5432
```

**选项 B：确认 PostgreSQL 运行在 5433 端口**
检查 PostgreSQL 配置文件 `postgresql.conf` 中的 `port` 设置。

#### 1.3 运行数据库迁移
```bash
cd server
npm run migrate
```

**预期创建的表：**
- `parents` - 家长账号表
- `children` - 孩子绑定表
- `usage_logs` - 使用记录表
- `parental_controls` - 家长控制设置表
- `email_verify_codes` - 邮箱验证码表

#### 1.4 验证数据库表创建
```bash
# 连接数据库
psql -h localhost -p 5432 -U admin -d qmzg

# 查看所有表
\dt

# 退出
\q
```

---

### 2. 环境变量配置 🔐

#### 2.1 生成安全的 JWT_SECRET
```bash
# 使用 Node.js 生成随机密钥
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"
```

将生成的密钥替换 `.env` 文件中的：
```
JWT_SECRET=your-super-secret-key-change-in-production
```

#### 2.2 修改数据库密码
当前密码 `dev_password_123` 过于简单，建议：
```
DB_PASSWORD=<使用强密码，至少16位，包含大小写字母、数字、特殊字符>
```

**注意：** 修改后需要在 PostgreSQL 中同步更新用户密码：
```sql
ALTER USER admin WITH PASSWORD '新密码';
```

#### 2.3 修正 CORS 配置
当前 `.env` 中：
```
CORS_ORIGIN=http://localhost:5175
```

应改为：
```
CORS_ORIGIN=http://localhost:5173
```

生产环境应改为实际域名：
```
CORS_ORIGIN=https://your-domain.com
```

#### 2.4 配置邮件服务（如需邮箱验证功能）
```
EMAIL_HOST=smtp.example.com
EMAIL_PORT=587
EMAIL_USER=your-email@example.com
EMAIL_PASSWORD=your-email-password
EMAIL_FROM=启蒙之光 <noreply@your-domain.com>
```

---

### 3. 安全检查 🛡️

#### 3.1 检查敏感信息
- [ ] 确认 `.env` 文件不在 git 版本控制中
- [ ] 确认所有默认密码已修改
- [ ] 确认 JWT_SECRET 已更换为强密钥
- [ ] 确认生产环境不使用开发模式

#### 3.2 代码安全审查
```bash
# 检查是否有硬编码的敏感信息
cd server
grep -r "password" --include="*.ts" --exclude-dir=node_modules
grep -r "secret" --include="*.ts" --exclude-dir=node_modules
```

#### 3.3 依赖安全检查
```bash
# 检查前端依赖漏洞
cd app
npm audit

# 检查后端依赖漏洞
cd ../server
npm audit

# 修复可自动修复的漏洞
npm audit fix
```

---

### 4. 功能测试 ✅

#### 4.1 启动服务
```bash
# 终端 1 - 启动后端
cd server
npm run dev

# 终端 2 - 启动前端
cd app
npm run dev
```

#### 4.2 测试核心功能

**家长端功能：**
- [ ] 家长注册（手机号 + 密码）
- [ ] 邮箱验证码发送与验证
- [ ] 家长登录
- [ ] 绑定孩子账号
- [ ] 查看孩子列表
- [ ] 设置时间控制（每日限制、游戏限制、时间段）
- [ ] 设置内容访问控制（游戏、创作、阅读、AI百科）
- [ ] 查看使用数据统计
- [ ] 查看成长报告

**儿童端功能：**
- [ ] 时间锁定弹窗（达到限制时）
- [ ] 内容访问限制（底部导航锁定图标）
- [ ] 受限页面访问拦截
- [ ] 使用时长自动记录

#### 4.3 运行 API 测试脚本
```bash
# 确保后端服务运行在 3000 端口
bash test-api.sh
```

**预期结果：**
- 健康检查返回 `{"status":"ok"}`
- 注册成功返回 token 和家长信息
- 登录成功返回 token 和家长信息

---

### 5. 生产构建 🏗️

#### 5.1 构建前端
```bash
cd app
npm run build
```

**检查构建输出：**
- [ ] 构建成功无错误
- [ ] 生成 `dist` 目录
- [ ] 检查 chunk 大小（建议 < 500KB）

#### 5.2 构建后端
```bash
cd server
npm run build
```

**检查构建输出：**
- [ ] 构建成功无错误
- [ ] 生成 `dist` 目录
- [ ] 所有 TypeScript 文件编译成功

#### 5.3 测试生产构建
```bash
# 启动生产模式后端
cd server
npm start

# 预览前端生产构建
cd app
npm run preview
```

---

## 📝 推荐完成项

### 6. 性能优化

- [ ] 前端代码分割（已通过 Vite 自动处理）
- [ ] 图片资源优化（压缩、WebP 格式）
- [ ] 启用 gzip 压缩
- [ ] 配置 CDN（静态资源）
- [ ] 数据库索引优化

### 7. 监控与日志

- [ ] 配置应用日志（Winston/Pino）
- [ ] 配置错误追踪（Sentry）
- [ ] 配置性能监控（New Relic/DataDog）
- [ ] 配置数据库监控

### 8. 备份策略

- [ ] 配置数据库自动备份
- [ ] 配置用户数据备份
- [ ] 测试备份恢复流程

---

## 🚀 部署步骤

### 9. 服务器准备

#### 9.1 服务器要求
- **操作系统：** Ubuntu 20.04+ / CentOS 7+ / Windows Server 2019+
- **Node.js：** v18.0.0+
- **PostgreSQL：** v14.0+
- **内存：** 最低 2GB，推荐 4GB+
- **存储：** 最低 20GB

#### 9.2 安装依赖
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y nodejs npm postgresql nginx

# CentOS/RHEL
sudo yum install -y nodejs npm postgresql-server nginx
```

### 10. 部署方式选择

#### 选项 A：传统服务器部署
参见 `部署文档-传统服务器.md`

#### 选项 B：Docker 部署
参见 `部署文档-Docker.md`

#### 选项 C：云平台部署
- **Vercel：** 前端部署
- **Railway/Render：** 后端部署
- **Supabase：** 数据库托管

---

## ⚠️ 当前已知问题

1. **数据库连接失败**
   - 状态：阻塞
   - 原因：PostgreSQL 服务未运行或端口配置错误
   - 解决：参见第 1 节

2. **前端构建警告**
   - 警告：`(!) Some chunks are larger than 500 kB after minification`
   - 影响：轻微，可能影响首屏加载速度
   - 建议：后续优化代码分割

3. **默认安全配置**
   - 状态：需修改
   - 影响：严重安全风险
   - 解决：参见第 2 节

---

## 📞 发布后检查清单

- [ ] 所有 API 端点正常响应
- [ ] 家长注册登录流程正常
- [ ] 时间控制功能正常触发
- [ ] 内容访问控制正常拦截
- [ ] 使用数据正常记录
- [ ] 数据库连接稳定
- [ ] 日志正常输出
- [ ] 错误监控正常上报
- [ ] 备份任务正常执行

---

## 📚 相关文档

- `部署文档-传统服务器.md` - 传统服务器部署详细步骤
- `部署文档-Docker.md` - Docker 容器化部署
- `.env.production.template` - 生产环境配置模板
- `deploy.sh` - 自动化部署脚本

---

**最后更新：** 2026-01-14
**版本：** v1.0.0

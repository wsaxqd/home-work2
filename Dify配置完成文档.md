# Dify AI 配置 - 完成文档

> 创建时间: 2026-01-19
> 状态: ⏳ 等待用户配置
> 优先级: 🔴 P0

---

## 📋 配置概述

本文档指导你完成 Dify AI 的配置,让"启蒙之光"项目的AI功能正常工作。

---

## ✅ 已完成的准备工作

我已经为你完成了以下准备工作:

### 1. 更新环境变量配置 ✅
- 已在 `server/.env` 添加 `AI_PROVIDER=dify` 配置
- 已设置默认使用 Dify 作为 AI 服务提供商

### 2. 创建配置指南 ✅
- `Dify配置快速指南.md` - 详细的配置步骤
- `DIFY_CONFIG_GUIDE.md` - 完整的配置文档

### 3. 验证脚本已就绪 ✅
- `server/scripts/check-dify-config.js` - 自动验证配置

---

## 🎯 你需要完成的操作

### 步骤概览 (预计1-2小时)

```
1. 注册Dify账号 (5分钟)
   ↓
2. 创建3个应用 (30-40分钟)
   • 聊天助手
   • 故事生成器
   • 情感分析器
   ↓
3. 获取3个API密钥 (5分钟)
   ↓
4. 更新.env配置 (5分钟)
   ↓
5. 验证配置 (5分钟)
   ↓
6. 测试功能 (10分钟)
```

---

## 📝 详细操作步骤

### 第一步: 注册Dify账号 ⏰ 5分钟

**1. 访问Dify**
```
https://cloud.dify.ai/
```

**2. 注册账号**
选择以下任一方式:
- [ ] 邮箱注册
- [ ] GitHub登录
- [ ] Google登录

**3. 验证邮箱** (如果使用邮箱注册)

---

### 第二步: 创建3个应用 ⏰ 30-40分钟

#### 应用1: 聊天助手 🤖

**操作步骤:**
1. 点击 "创建应用" 按钮
2. 选择应用类型: **聊天助手 (Chat Assistant)**
3. 填写应用信息:
   ```
   名称: 启蒙之光-AI助手
   描述: 儿童情感陪伴AI助手
   ```
4. 配置模型: 选择 **GPT-3.5-turbo** (推荐)

5. 设置系统提示词 (复制以下内容):
```
你是一个温暖、友善的AI助手，名叫"小启"。你的任务是陪伴6-12岁的儿童，提供情感支持和鼓励。

你的特点：
- 使用简单、易懂的语言
- 充满耐心和爱心
- 善于倾听和理解孩子的情绪
- 给予积极的鼓励和建议
- 避免使用复杂的词汇和概念

回复要求：
- 每次回复控制在2-3句话
- 使用温暖、友好的语气
- 适当使用表情符号增加亲和力
- 关注孩子的情绪和感受
```

6. **保存并发布应用**

7. 获取API密钥:
   - 进入应用详情 → "API访问" → "创建API密钥"
   - 复制密钥 (格式: `app-xxxxxxxx`)
   - 保存到记事本: `DIFY_CHAT_APP_KEY=app-你的密钥`

---

#### 应用2: 故事生成器 📖

**操作步骤:**
1. 创建应用 → 选择 **文本生成 (Text Generator)**
2. 填写信息:
   ```
   名称: 启蒙之光-故事生成器
   描述: 为儿童生成有趣的故事
   ```
3. 选择模型: **GPT-3.5-turbo**

4. 设置提示词模板 (复制以下内容):
```
请根据以下信息为6-12岁的儿童创作一个有趣的故事：

主题：{{theme}}
主角：{{character}}
地点：{{location}}
风格：{{style}}

要求：
- 故事要有教育意义
- 语言简单易懂
- 情节生动有趣
- 传递正能量
- 适合儿童阅读
- 字数在500-1000字之间

请直接输出故事内容，包含标题。
```

5. 添加变量:
   - `theme` (必填): 故事主题
   - `character` (必填): 主角名字
   - `location` (必填): 故事地点
   - `style` (可选): 故事风格

6. **保存并发布应用**

7. 获取API密钥并保存:
   - `DIFY_STORY_APP_KEY=app-你的密钥`

---

#### 应用3: 情感分析器 💝

**操作步骤:**
1. 创建应用 → 选择 **文本生成 (Text Generator)**
2. 填写信息:
   ```
   名称: 启蒙之光-情感分析
   描述: 分析儿童情感并提供建议
   ```
3. 选择模型: **GPT-3.5-turbo**

4. 设置提示词 (复制以下内容):
```
请分析以下文本中表达的情感，并给出温暖的回应建议：

文本内容：{{text}}

请以 JSON 格式返回：
{
  "emotion": "情感类型（happy/sad/angry/worried/excited/calm）",
  "confidence": 0.95,
  "suggestions": ["建议1", "建议2", "建议3"]
}

要求：
- 准确识别儿童的情感
- 给出适合6-12岁儿童的温暖建议
- 建议要具体、可行、积极向上
```

5. 添加变量:
   - `text` (必填): 待分析的文本

6. **保存并发布应用**

7. 获取API密钥并保存:
   - `DIFY_EMOTION_APP_KEY=app-你的密钥`

---

### 第三步: 更新项目配置 ⏰ 5分钟

**1. 打开配置文件**
```bash
文件路径: server/.env
```

**2. 更新Dify配置** (替换以下3个密钥):
```env
# Dify AI配置
DIFY_API_URL=https://api.dify.ai/v1
DIFY_CHAT_APP_KEY=app-你的聊天助手密钥        # ← 在这里粘贴
DIFY_STORY_APP_KEY=app-你的故事生成密钥       # ← 在这里粘贴
DIFY_EMOTION_APP_KEY=app-你的情感分析密钥     # ← 在这里粘贴
```

**3. 确认AI提供商设置**
```env
AI_PROVIDER=dify  # ✅ 已设置
```

**4. 保存文件**

---

### 第四步: 验证配置 ⏰ 5分钟

**1. 运行验证脚本**
```bash
cd server
node scripts/check-dify-config.js
```

**2. 查看验证结果**

**✅ 成功示例:**
```
🔍 Dify 配置检查工具
==================================================
📋 步骤 1: 检查环境变量
==================================================
✅ DIFY_API_URL: 已配置
✅ DIFY_CHAT_APP_KEY: 已配置
✅ DIFY_STORY_APP_KEY: 已配置
✅ DIFY_EMOTION_APP_KEY: 已配置

==================================================
📋 步骤 2: 测试聊天应用连接
==================================================
✅ 聊天应用连接成功
   回复: 你好！我是小启，很高兴认识你...
```

**❌ 失败示例:**
```
❌ DIFY_CHAT_APP_KEY: 未配置或使用占位符
⚠️  请先配置 .env 文件中的 Dify API 密钥
```

---

### 第五步: 启动服务并测试 ⏰ 10分钟

**1. 启动后端服务**
```bash
cd server
npm run dev
```

**2. 启动前端**
```bash
cd app
npm run dev
```

**3. 测试AI对话**
- 访问: `http://localhost:5174`
- 进入 "AI情感陪伴" 页面
- 发送消息: "你好"
- 检查回复是否智能、自然

**4. 测试故事生成**
- 进入 "故事创作" 页面
- 选择主题和角色
- 生成故事
- 检查故事质量

---

## ✅ 验收标准

配置成功后,应该满足以下所有条件:

### 基础配置 ✅
- [x] Dify账号已注册
- [x] 3个应用已创建并发布
- [x] 3个API密钥已获取
- [x] .env文件已更新
- [x] `AI_PROVIDER=dify` 已设置

### 功能测试 ✅
- [ ] 验证脚本运行成功
- [ ] AI对话返回智能回复 (非模拟数据)
- [ ] 故事生成功能正常
- [ ] 响应速度 < 5秒
- [ ] 无认证错误

### 日志检查 ✅
- [ ] 服务启动无错误
- [ ] 无 "使用模拟回复" 提示
- [ ] 无 401/403 认证错误

---

## 🔍 常见问题排查

### Q1: 验证脚本报错 "未配置"

**原因**: API密钥未正确填写

**解决**:
1. 检查 `.env` 文件中的密钥是否包含 `app-` 前缀
2. 确认没有多余的空格或引号
3. 密钥必须是完整的字符串

### Q2: 认证失败 (401错误)

**原因**: API密钥无效或应用未发布

**解决**:
1. 确认Dify应用已点击"发布"按钮
2. 重新生成API密钥并更新配置
3. 检查是否复制了正确的密钥

### Q3: 仍然返回模拟回复

**原因**: AI_PROVIDER未设置或服务未重启

**解决**:
1. 确认 `AI_PROVIDER=dify` 已设置
2. 重启后端服务 (必须重启)
3. 清除浏览器缓存

### Q4: 响应很慢或超时

**原因**: 网络延迟或模型选择

**解决**:
1. 检查网络连接
2. 使用GPT-3.5-turbo (比GPT-4快)
3. 增加 `DIFY_TIMEOUT` 值

---

## 📊 配置进度表

请在完成每一步后打勾:

**账号准备**
- [ ] 已访问 Dify 云服务
- [ ] 已注册账号
- [ ] 已验证邮箱

**应用创建**
- [ ] 已创建聊天助手应用
- [ ] 已创建故事生成器应用
- [ ] 已创建情感分析器应用
- [ ] 所有应用都已发布

**密钥获取**
- [ ] 聊天助手密钥: `app-________`
- [ ] 故事生成密钥: `app-________`
- [ ] 情感分析密钥: `app-________`

**配置更新**
- [ ] 已打开 server/.env 文件
- [ ] 已粘贴聊天助手密钥
- [ ] 已粘贴故事生成密钥
- [ ] 已粘贴情感分析密钥
- [ ] 已确认 AI_PROVIDER=dify
- [ ] 已保存文件

**验证测试**
- [ ] 验证脚本运行成功
- [ ] AI对话功能正常
- [ ] 故事生成功能正常
- [ ] 无错误日志

---

## 🎉 完成后的效果

配置成功后,你将拥有:

### AI对话功能 🤖
- 智能、自然的对话
- 符合儿童语言风格
- 情感理解和回应

### 故事生成功能 📖
- 根据主题自动创作
- 内容丰富有趣
- 适合儿童阅读

### 情感分析功能 💝
- 识别儿童情绪
- 提供温暖建议
- 心理健康支持

---

## 📚 参考文档

- **完整配置指南**: `DIFY_CONFIG_GUIDE.md`
- **快速操作指南**: `Dify配置快速指南.md`
- **Dify官方文档**: https://docs.dify.ai/
- **验证脚本**: `server/scripts/check-dify-config.js`

---

## 💡 费用说明

### 免费额度
- Dify新用户有免费试用额度
- 足够完成功能测试和演示
- 日常开发使用

### 付费升级 (可选)
- 如果免费额度用完
- 按需购买API调用次数
- 或订阅月度套餐

**建议**: 先用免费额度测试功能,确认满意后再考虑付费

---

## 🎯 下一步建议

完成Dify配置后:

1. **立即**: 测试所有AI功能
2. **今天**: 继续完成其他高优先级任务
   - 邮件服务配置
   - 短信验证码实现
3. **本周**: 完善和优化
   - 调整提示词
   - 优化响应速度
   - 添加错误处理

---

## 📞 获取帮助

如果遇到问题:

1. **查看本文档** 的常见问题部分
2. **运行验证脚本** 查看详细错误
3. **查看Dify文档**: https://docs.dify.ai/
4. **检查服务器日志** 获取错误详情

---

**祝配置顺利!** 🎊

按照本文档逐步操作,你将成功配置Dify AI,让项目拥有真正的AI智能!

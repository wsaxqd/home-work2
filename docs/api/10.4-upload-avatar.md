# API 10.4 - 上传头像

## 接口信息

- **接口名称**: 上传头像
- **请求方法**: POST
- **请求路径**: `/api/upload/avatar`
- **需要认证**: 是

---

## 接口描述

上传用户头像，会自动裁剪为正方形并生成多种尺寸，同时更新用户信息中的头像URL。

---

## 请求参数

### Header参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Authorization | String | 是 | Bearer {accessToken} |
| Content-Type | String | 是 | multipart/form-data |

### FormData参数
| 参数名 | 类型 | 必填 | 说明 | 限制 |
|--------|------|------|------|------|
| avatar | File | 是 | 头像图片文件 | jpg/jpeg/png, 最大2MB |

### 请求示例

```javascript
// JavaScript FormData示例
const formData = new FormData();
formData.append('avatar', avatarInput.files[0]);

fetch('http://localhost:3000/api/upload/avatar', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + accessToken
  },
  body: formData
});
```

---

## 响应结果

### 成功响应 (200 OK)

```json
{
  "success": true,
  "message": "头像上传成功",
  "data": {
    "avatar": {
      "original": "https://example.com/uploads/avatars/550e8400-e29b-41d4-a716-446655440000.jpg",
      "large": "https://example.com/uploads/avatars/550e8400-e29b-41d4-a716-446655440000_large.jpg",
      "medium": "https://example.com/uploads/avatars/550e8400-e29b-41d4-a716-446655440000_medium.jpg",
      "small": "https://example.com/uploads/avatars/550e8400-e29b-41d4-a716-446655440000_small.jpg",
      "thumbnail": "https://example.com/uploads/avatars/550e8400-e29b-41d4-a716-446655440000_thumb.jpg"
    },
    "filename": "550e8400-e29b-41d4-a716-446655440000.jpg",
    "originalName": "my-avatar.jpg",
    "size": 156789,
    "dimensions": {
      "original": { "width": 800, "height": 800 },
      "large": { "width": 400, "height": 400 },
      "medium": { "width": 200, "height": 200 },
      "small": { "width": 100, "height": 100 },
      "thumbnail": { "width": 50, "height": 50 }
    },
    "uploadedAt": "2024-12-22T10:30:00.000Z"
  }
}
```

### 错误响应

#### 400 Bad Request - 参数错误
```json
{
  "success": false,
  "message": "未选择头像文件"
}
```

#### 400 Bad Request - 文件格式错误
```json
{
  "success": false,
  "message": "头像格式不支持，请上传jpg/jpeg/png格式"
}
```

#### 400 Bad Request - 文件过大
```json
{
  "success": false,
  "message": "头像大小超出限制，最大2MB"
}
```

#### 401 Unauthorized - 未授权
```json
{
  "success": false,
  "message": "请先登录"
}
```

#### 500 Internal Server Error - 服务器错误
```json
{
  "success": false,
  "message": "上传失败，请稍后重试"
}
```

---

## 字段说明

### 响应字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| avatar.original | String | 原始头像URL(800x800) |
| avatar.large | String | 大尺寸头像URL(400x400) |
| avatar.medium | String | 中等尺寸头像URL(200x200) |
| avatar.small | String | 小尺寸头像URL(100x100) |
| avatar.thumbnail | String | 缩略图头像URL(50x50) |
| filename | String | 服务器存储文件名 |
| originalName | String | 原始文件名 |
| size | Number | 文件大小(字节) |
| dimensions | Object | 各尺寸的宽高信息 |
| uploadedAt | DateTime | 上传时间 |

---

## 业务规则

1. 支持的格式：jpg, jpeg, png
2. 最大文件大小：2MB
3. 自动裁剪为正方形
4. 自动生成5种尺寸：
   - original: 800x800px
   - large: 400x400px
   - medium: 200x200px
   - small: 100x100px
   - thumbnail: 50x50px
5. 上传成功后自动更新用户信息
6. 旧头像会被自动删除
7. 所有尺寸都经过压缩优化

---

## 使用场景

- 用户设置页面更换头像
- 个人资料编辑
- 注册流程中上传头像
- 头像裁剪后上传

---

## 注意事项

1. 建议前端先进行图片裁剪再上传
2. 上传成功后旧头像会被删除
3. 返回的medium尺寸适合大多数场景使用
4. 系统会自动选择最合适的尺寸展示
5. 头像URL会同步更新到用户信息

---

## Postman测试

### 配置步骤
1. 创建新请求
2. 选择方法：`POST`
3. 输入URL：`http://localhost:3000/api/upload/avatar`
4. 在Headers中添加：
   - Key: `Authorization`
   - Value: `Bearer {你的accessToken}`
5. 在Body中选择`form-data`
6. 添加字段：
   - Key: `avatar`, Type: `File`, Value: 选择头像图片
7. 点击`Send`发送请求

### 预期结果
- 状态码：200
- 返回多种尺寸的头像URL
- 用户信息中的头像已更新

---

## 相关接口

- [2.1 获取当前用户信息](./2.1-get-profile.md)
- [2.2 更新用户信息](./2.2-update-profile.md)
- [10.5 删除文件](./10.5-delete-file.md)

---

## 更新记录

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2024-12-22 | 初始版本 |

---

**维护者**: AI Assistant
**最后更新**: 2024-12-22

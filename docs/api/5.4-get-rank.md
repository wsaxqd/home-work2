# API 5.4 - 获取用户排名

## 接口信息

- **接口名称**: 获取用户排名
- **请求方法**: GET
- **请求路径**: `/api/games/rank`
- **需要认证**: 是

---

## 接口描述

获取当前用户在指定游戏类型中的详细排名信息，包括总排名、关卡排名、超越百分比等数据。

---

## 请求参数

### Header参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Authorization | String | 是 | Bearer {accessToken} |

### Query参数
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| game_type | String | 是 | 游戏类型(puzzle/memory/quiz) | "puzzle" |
| level | Integer | 否 | 关卡(不传则返回总排名) | 5 |

### 请求示例

```
GET /api/games/rank?game_type=puzzle&level=5
```

---

## 响应结果

### 成功响应 (200 OK)

```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "game_type": "puzzle",
    "level": 5,
    "rank_info": {
      "rank": 15,
      "total_players": 1580,
      "percentile": 99.05,
      "score": 95,
      "best_score": 95,
      "time_spent": 180,
      "best_time": 180,
      "stars": 3,
      "play_count": 3
    },
    "nearby_ranks": [
      {
        "rank": 13,
        "nickname": "玩家A",
        "avatar": "https://example.com/avatar1.jpg",
        "score": 96,
        "time_spent": 175
      },
      {
        "rank": 14,
        "nickname": "玩家B",
        "avatar": "https://example.com/avatar2.jpg",
        "score": 96,
        "time_spent": 178
      },
      {
        "rank": 15,
        "nickname": "我",
        "avatar": "https://example.com/my-avatar.jpg",
        "score": 95,
        "time_spent": 180,
        "is_current_user": true
      },
      {
        "rank": 16,
        "nickname": "玩家C",
        "avatar": "https://example.com/avatar3.jpg",
        "score": 95,
        "time_spent": 185
      },
      {
        "rank": 17,
        "nickname": "玩家D",
        "avatar": "https://example.com/avatar4.jpg",
        "score": 94,
        "time_spent": 170
      }
    ],
    "top_ranks": [
      {
        "rank": 1,
        "nickname": "榜首",
        "avatar": "https://example.com/top1.jpg",
        "score": 100,
        "time_spent": 120
      },
      {
        "rank": 2,
        "nickname": "亚军",
        "avatar": "https://example.com/top2.jpg",
        "score": 99,
        "time_spent": 125
      },
      {
        "rank": 3,
        "nickname": "季军",
        "avatar": "https://example.com/top3.jpg",
        "score": 98,
        "time_spent": 130
      }
    ],
    "rank_trend": {
      "last_rank": 18,
      "change": 3,
      "trend": "up"
    }
  }
}
```

### 错误响应

#### 400 Bad Request - 参数错误
```json
{
  "success": false,
  "message": "游戏类型不正确"
}
```

#### 401 Unauthorized - 未授权
```json
{
  "success": false,
  "message": "未授权，请先登录"
}
```

#### 404 Not Found - 无排名数据
```json
{
  "success": false,
  "message": "您还没有该游戏的成绩记录"
}
```

#### 500 Internal Server Error - 服务器错误
```json
{
  "success": false,
  "message": "获取排名失败，请稍后重试"
}
```

---

## 字段说明

### 响应字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| game_type | String | 游戏类型 |
| level | Integer | 关卡(null表示总排名) |
| rank_info | Object | 排名信息 |
| rank | Integer | 当前排名 |
| total_players | Integer | 总玩家数 |
| percentile | Float | 超越百分比 |
| score | Integer | 当前得分 |
| best_score | Integer | 历史最佳分数 |
| time_spent | Integer | 用时(秒) |
| best_time | Integer | 历史最短用时 |
| stars | Integer | 星级 |
| play_count | Integer | 游戏次数 |
| nearby_ranks | Array | 附近排名(前后各2名) |
| top_ranks | Array | 前三名榜单 |
| rank_trend | Object | 排名变化趋势 |
| change | Integer | 排名变化(正数为上升) |
| trend | String | 趋势(up/down/stable) |

---

## 业务规则

1. percentile = ((total_players - rank) / total_players) × 100
2. nearby_ranks返回当前用户前后各2名的玩家
3. top_ranks始终返回前3名玩家
4. rank_trend.last_rank为上次查询时的排名
5. 如果用户未玩过该关卡，返回404
6. 不传level时返回该游戏类型的总排名

---

## 使用场景

- 个人中心展示游戏排名
- 游戏结束后查看排名变化
- 排名提升激励通知
- 游戏成就系统

---

## 注意事项

1. 排名数据有缓存，可能有延迟
2. percentile保留2位小数
3. nearby_ranks在排名靠前/靠后时可能少于5条
4. rank_trend需要至少2次查询才有数据
5. 建议合理控制查询频率

---

## Postman测试

### 配置步骤
1. 创建新请求
2. 选择方法：`GET`
3. 输入URL：`http://localhost:3000/api/games/rank`
4. 在Headers中添加：
   - `Authorization`: `Bearer {你的accessToken}`
5. 在Params中添加：
   - Key: `game_type`, Value: `puzzle`
   - Key: `level`, Value: `5`
6. 点击`Send`发送请求

### 预期结果
- 状态码：200
- 返回详细的排名信息
- nearby_ranks显示附近玩家
- top_ranks显示前三名
- rank_trend显示排名变化

---

## 相关接口

- [5.1 保存游戏成绩](./5.1-save-score.md)
- [5.2 获取游戏进度](./5.2-get-progress.md)
- [5.3 获取排行榜](./5.3-get-leaderboard.md)
- [5.5 获取游戏历史记录](./5.5-get-history.md)

---

## 更新记录

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2024-12-22 | 初始版本 |

---

**维护者**: AI Assistant
**最后更新**: 2024-12-22

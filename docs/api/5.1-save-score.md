# API 5.1 - 保存游戏成绩

## 接口信息

- **接口名称**: 保存游戏成绩
- **请求方法**: POST
- **请求路径**: `/api/games/score`
- **需要认证**: 是

---

## 接口描述

保存用户完成游戏后的成绩数据，包括得分、用时、关卡等信息。系统会自动更新用户的游戏进度和排行榜数据。

---

## 请求参数

### Header参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Content-Type | String | 是 | application/json |
| Authorization | String | 是 | Bearer {accessToken} |

### Body参数
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| game_type | String | 是 | 游戏类型(puzzle/memory/quiz) | "puzzle" |
| score | Integer | 是 | 游戏得分 | 95 |
| level | Integer | 是 | 游戏关卡 | 5 |
| time_spent | Integer | 是 | 用时(秒) | 180 |
| stars | Integer | 否 | 获得星级(1-3) | 3 |
| details | Object | 否 | 游戏详细数据 | {} |

### 请求示例

```json
{
  "game_type": "puzzle",
  "score": 95,
  "level": 5,
  "time_spent": 180,
  "stars": 3,
  "details": {
    "correct_answers": 18,
    "total_questions": 20,
    "combo_max": 10
  }
}
```

---

## 响应结果

### 成功响应 (201 Created)

```json
{
  "success": true,
  "message": "成绩保存成功",
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "user_id": "660e8400-e29b-41d4-a716-446655440000",
    "game_type": "puzzle",
    "score": 95,
    "level": 5,
    "time_spent": 180,
    "stars": 3,
    "details": {
      "correct_answers": 18,
      "total_questions": 20,
      "combo_max": 10
    },
    "is_best": true,
    "rank": 15,
    "created_at": "2024-12-21T14:30:00.000Z"
  }
}
```

### 错误响应

#### 400 Bad Request - 参数错误
```json
{
  "success": false,
  "message": "游戏类型不正确"
}
```

#### 401 Unauthorized - 未授权
```json
{
  "success": false,
  "message": "未授权，请先登录"
}
```

#### 500 Internal Server Error - 服务器错误
```json
{
  "success": false,
  "message": "保存成绩失败，请稍后重试"
}
```

---

## 字段说明

### 响应字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | UUID | 成绩记录ID |
| user_id | UUID | 用户ID |
| game_type | String | 游戏类型 |
| score | Integer | 得分 |
| level | Integer | 关卡 |
| time_spent | Integer | 用时(秒) |
| stars | Integer | 星级评价 |
| details | Object | 详细数据 |
| is_best | Boolean | 是否为最佳成绩 |
| rank | Integer | 当前排名 |
| created_at | DateTime | 创建时间 |

---

## 业务规则

1. 同一用户同一关卡可多次提交成绩
2. 系统自动判断是否为该用户的最佳成绩
3. 最佳成绩会更新到排行榜
4. 星级评价根据得分自动计算：90分以上3星，70-89分2星，60-69分1星
5. 用时越短，排名越靠前
6. details字段可存储游戏相关的自定义数据

---

## 使用场景

- 用户完成游戏关卡后保存成绩
- 闯关模式记录每关得分
- 练习模式保存练习记录
- 生成游戏统计报告的数据来源

---

## 注意事项

1. 成绩数据应在客户端验证后再提交
2. 建议实现防作弊机制
3. time_spent应准确记录实际游戏时间
4. details字段大小不应超过10KB
5. 高并发场景下注意排名更新的性能

---

## Postman测试

### 配置步骤
1. 创建新请求
2. 选择方法：`POST`
3. 输入URL：`http://localhost:3000/api/games/score`
4. 在Headers中添加：
   - `Content-Type`: `application/json`
   - `Authorization`: `Bearer {你的accessToken}`
5. 选择Body标签
6. 选择`raw`和`JSON`格式
7. 输入请求体（见上方示例）
8. 点击`Send`发送请求

### 预期结果
- 状态码：201
- 返回保存的成绩信息
- is_best字段显示是否为最佳成绩
- rank字段显示当前排名

---

## 相关接口

- [5.2 获取游戏进度](./5.2-get-progress.md)
- [5.3 获取排行榜](./5.3-get-leaderboard.md)
- [5.4 获取用户排名](./5.4-get-rank.md)
- [5.5 获取游戏历史记录](./5.5-get-history.md)

---

## 更新记录

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2024-12-22 | 初始版本 |

---

**维护者**: AI Assistant
**最后更新**: 2024-12-22

# API 5.3 - 获取排行榜

## 接口信息

- **接口名称**: 获取排行榜
- **请求方法**: GET
- **请求路径**: `/api/games/leaderboard`
- **需要认证**: 是

---

## 接口描述

获取指定游戏类型和关卡的排行榜数据，支持按得分、用时等维度排序，可查看全服排行或好友排行。

---

## 请求参数

### Header参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Authorization | String | 是 | Bearer {accessToken} |

### Query参数
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| game_type | String | 是 | 游戏类型(puzzle/memory/quiz) | "puzzle" |
| level | Integer | 否 | 关卡(不传则为总排行) | 5 |
| type | String | 否 | 排行类型(all/friends，默认all) | "all" |
| limit | Integer | 否 | 返回数量(默认50，最大100) | 20 |
| offset | Integer | 否 | 偏移量(默认0) | 0 |

### 请求示例

```
GET /api/games/leaderboard?game_type=puzzle&level=5&type=all&limit=20
```

---

## 响应结果

### 成功响应 (200 OK)

```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "game_type": "puzzle",
    "level": 5,
    "type": "all",
    "total": 1580,
    "list": [
      {
        "rank": 1,
        "user_id": "550e8400-e29b-41d4-a716-446655440000",
        "nickname": "小明",
        "avatar": "https://example.com/avatar1.jpg",
        "score": 100,
        "time_spent": 120,
        "stars": 3,
        "is_current_user": false,
        "created_at": "2024-12-21T10:30:00.000Z"
      },
      {
        "rank": 2,
        "user_id": "660e8400-e29b-41d4-a716-446655440000",
        "nickname": "小红",
        "avatar": "https://example.com/avatar2.jpg",
        "score": 98,
        "time_spent": 125,
        "stars": 3,
        "is_current_user": true,
        "created_at": "2024-12-21T11:20:00.000Z"
      },
      {
        "rank": 3,
        "user_id": "770e8400-e29b-41d4-a716-446655440000",
        "nickname": "小刚",
        "avatar": "https://example.com/avatar3.jpg",
        "score": 95,
        "time_spent": 130,
        "stars": 3,
        "is_current_user": false,
        "created_at": "2024-12-21T12:15:00.000Z"
      }
    ],
    "current_user_rank": {
      "rank": 2,
      "score": 98,
      "time_spent": 125,
      "stars": 3
    }
  }
}
```

### 错误响应

#### 400 Bad Request - 参数错误
```json
{
  "success": false,
  "message": "游戏类型不正确"
}
```

#### 401 Unauthorized - 未授权
```json
{
  "success": false,
  "message": "未授权，请先登录"
}
```

#### 500 Internal Server Error - 服务器错误
```json
{
  "success": false,
  "message": "获取排行榜失败，请稍后重试"
}
```

---

## 字段说明

### 响应字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| game_type | String | 游戏类型 |
| level | Integer | 关卡(null表示总排行) |
| type | String | 排行类型 |
| total | Integer | 总记录数 |
| list | Array | 排行榜列表 |
| rank | Integer | 排名 |
| user_id | UUID | 用户ID |
| nickname | String | 用户昵称 |
| avatar | String | 用户头像 |
| score | Integer | 得分 |
| time_spent | Integer | 用时(秒) |
| stars | Integer | 星级 |
| is_current_user | Boolean | 是否为当前用户 |
| current_user_rank | Object | 当前用户排名信息 |

---

## 业务规则

1. 排行榜按得分从高到低排序，得分相同按用时从短到长排序
2. 每个用户每个关卡只展示最佳成绩
3. type为friends时只显示已添加好友的排名
4. 不传level参数时返回该游戏类型的总排行榜
5. current_user_rank始终返回当前用户的排名，即使不在返回列表中
6. limit最大值为100，超过则自动限制为100

---

## 使用场景

- 游戏关卡结束后查看排名
- 排行榜页面展示
- 好友竞技系统
- 激励用户提升成绩

---

## 注意事项

1. 排行榜数据有缓存，更新可能有1-5分钟延迟
2. 大量用户场景下建议使用分页加载
3. is_current_user字段方便客户端高亮显示
4. 头像URL可能为null，需做默认头像处理
5. 排行榜数据量大时建议实现虚拟滚动

---

## Postman测试

### 配置步骤
1. 创建新请求
2. 选择方法：`GET`
3. 输入URL：`http://localhost:3000/api/games/leaderboard`
4. 在Headers中添加：
   - `Authorization`: `Bearer {你的accessToken}`
5. 在Params中添加：
   - Key: `game_type`, Value: `puzzle`
   - Key: `level`, Value: `5`
   - Key: `type`, Value: `all`
   - Key: `limit`, Value: `20`
6. 点击`Send`发送请求

### 预期结果
- 状态码：200
- 返回排行榜数据列表
- current_user_rank显示当前用户排名
- is_current_user标记当前用户

---

## 相关接口

- [5.1 保存游戏成绩](./5.1-save-score.md)
- [5.2 获取游戏进度](./5.2-get-progress.md)
- [5.4 获取用户排名](./5.4-get-rank.md)
- [3.3 获取好友列表](./3.3-get-friends.md)

---

## 更新记录

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2024-12-22 | 初始版本 |

---

**维护者**: AI Assistant
**最后更新**: 2024-12-22

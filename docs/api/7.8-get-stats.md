# API 7.8 - 获取AI使用统计

## 接口信息

- **接口名称**: 获取AI使用统计
- **请求方法**: GET
- **请求路径**: `/api/ai/stats`
- **需要认证**: 是

---

## 接口描述

获取用户的AI服务使用统计数据，包括各类型服务的使用次数、Token消耗、时间分布等信息。

---

## 请求参数

### Header参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Authorization | String | 是 | Bearer {accessToken} |

### Query参数
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| start_date | String | 否 | 开始日期(YYYY-MM-DD，默认30天前) | "2024-11-21" |
| end_date | String | 否 | 结束日期(YYYY-MM-DD，默认今天) | "2024-12-21" |
| period | String | 否 | 统计周期(day/week/month，默认day) | "day" |

### 请求示例

```
GET /api/ai/stats?start_date=2024-11-21&end_date=2024-12-21&period=day
```

---

## 响应结果

### 成功响应 (200 OK)

```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "period": "day",
    "start_date": "2024-11-21",
    "end_date": "2024-12-21",
    "total_usage": {
      "total_requests": 156,
      "total_tokens": 125000,
      "total_cost": 12.5
    },
    "usage_by_type": {
      "chat": {
        "count": 85,
        "tokens": 68000,
        "percentage": 54.49
      },
      "story": {
        "count": 25,
        "tokens": 35000,
        "percentage": 16.03
      },
      "image": {
        "count": 30,
        "tokens": 15000,
        "percentage": 19.23
      },
      "emotion": {
        "count": 10,
        "tokens": 5000,
        "percentage": 6.41
      },
      "voice": {
        "count": 6,
        "tokens": 2000,
        "percentage": 3.85
      }
    },
    "daily_trend": [
      {
        "date": "2024-12-21",
        "requests": 12,
        "tokens": 9500
      },
      {
        "date": "2024-12-20",
        "requests": 8,
        "tokens": 6200
      },
      {
        "date": "2024-12-19",
        "requests": 15,
        "tokens": 11000
      }
    ],
    "peak_hours": [
      {
        "hour": 20,
        "count": 35,
        "label": "20:00-21:00"
      },
      {
        "hour": 19,
        "count": 28,
        "label": "19:00-20:00"
      },
      {
        "hour": 21,
        "count": 22,
        "label": "21:00-22:00"
      }
    ],
    "quota": {
      "daily_limit": 100,
      "daily_used": 12,
      "daily_remaining": 88,
      "monthly_limit": 3000,
      "monthly_used": 450,
      "monthly_remaining": 2550
    },
    "popular_topics": [
      {
        "topic": "学习问答",
        "count": 35
      },
      {
        "topic": "故事创作",
        "count": 25
      },
      {
        "topic": "图片识别",
        "count": 20
      }
    ]
  }
}
```

### 错误响应

#### 400 Bad Request - 参数错误
```json
{
  "success": false,
  "message": "日期格式不正确"
}
```

#### 401 Unauthorized - 未授权
```json
{
  "success": false,
  "message": "未授权，请先登录"
}
```

#### 500 Internal Server Error - 服务器错误
```json
{
  "success": false,
  "message": "获取统计数据失败，请稍后重试"
}
```

---

## 字段说明

### 响应字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| period | String | 统计周期 |
| start_date | String | 开始日期 |
| end_date | String | 结束日期 |
| total_usage | Object | 总体使用统计 |
| total_requests | Integer | 总请求次数 |
| total_tokens | Integer | 总Token消耗 |
| total_cost | Float | 总成本(元) |
| usage_by_type | Object | 按类型统计 |
| count | Integer | 使用次数 |
| tokens | Integer | Token消耗 |
| percentage | Float | 占比(%) |
| daily_trend | Array | 每日趋势 |
| peak_hours | Array | 使用高峰时段 |
| quota | Object | 配额信息 |
| daily_limit | Integer | 每日限额 |
| daily_used | Integer | 今日已用 |
| daily_remaining | Integer | 今日剩余 |
| popular_topics | Array | 热门主题 |

---

## 业务规则

1. 默认统计最近30天数据
2. period=day时daily_trend按天统计
3. period=week时按周统计
4. period=month时按月统计
5. percentage保留2位小数
6. peak_hours统计24小时内的使用分布
7. quota显示当前配额使用情况
8. popular_topics根据使用内容自动分类

---

## 使用场景

- 个人中心展示使用统计
- AI使用报告生成
- 配额使用监控
- 用户行为分析
- 功能优化参考

---

## 注意事项

1. 时间范围最大不超过1年
2. 数据有缓存，可能有5分钟延迟
3. percentage总和为100%
4. quota信息实时更新
5. 建议使用图表展示数据

---

## Postman测试

### 配置步骤
1. 创建新请求
2. 选择方法：`GET`
3. 输入URL：`http://localhost:3000/api/ai/stats`
4. 在Headers中添加：
   - `Authorization`: `Bearer {你的accessToken}`
5. 在Params中添加（可选）：
   - Key: `start_date`, Value: `2024-11-21`
   - Key: `end_date`, Value: `2024-12-21`
   - Key: `period`, Value: `day`
6. 点击`Send`发送请求

### 预期结果
- 状态码：200
- 返回详细统计数据
- usage_by_type显示各类型使用情况
- quota显示配额信息

---

## 相关接口

- [7.1 AI对话](./7.1-chat.md)
- [7.7 获取AI使用历史](./7.7-get-history.md)

---

## 更新记录

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2024-12-22 | 初始版本 |

---

**维护者**: AI Assistant
**最后更新**: 2024-12-22

# API 7.7 - 获取AI使用历史

## 接口信息

- **接口名称**: 获取AI使用历史
- **请求方法**: GET
- **请求路径**: `/api/ai/history`
- **需要认证**: 是

---

## 接口描述

获取用户的AI服务使用历史记录，包括对话、故事生成、图像识别等所有AI功能的使用记录。

---

## 请求参数

### Header参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Authorization | String | 是 | Bearer {accessToken} |

### Query参数
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| type | String | 否 | 服务类型(chat/story/image/emotion/voice，不传则全部) | "chat" |
| start_date | String | 否 | 开始日期(YYYY-MM-DD) | "2024-12-01" |
| end_date | String | 否 | 结束日期(YYYY-MM-DD) | "2024-12-31" |
| limit | Integer | 否 | 返回数量(默认20，最大100) | 20 |
| offset | Integer | 否 | 偏移量(默认0) | 0 |

### 请求示例

```
GET /api/ai/history?type=chat&limit=20&offset=0
```

---

## 响应结果

### 成功响应 (200 OK)

```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "total": 156,
    "page": 1,
    "limit": 20,
    "list": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "type": "chat",
        "title": "关于光合作用的问答",
        "content": {
          "user_message": "什么是光合作用？",
          "assistant_message": "光合作用是植物、藻类和某些细菌..."
        },
        "tokens_used": 125,
        "created_at": "2024-12-21T14:30:00.000Z"
      },
      {
        "id": "660e8400-e29b-41d4-a716-446655440000",
        "type": "story",
        "title": "勇闯神秘森林",
        "content": {
          "theme": "勇敢探险",
          "word_count": 850
        },
        "tokens_used": 1200,
        "created_at": "2024-12-21T10:15:00.000Z"
      },
      {
        "id": "770e8400-e29b-41d4-a716-446655440000",
        "type": "image",
        "title": "图像识别",
        "content": {
          "image_url": "https://example.com/image.jpg",
          "results": ["猫", "宠物", "室内"]
        },
        "tokens_used": 80,
        "created_at": "2024-12-20T16:45:00.000Z"
      },
      {
        "id": "880e8400-e29b-41d4-a716-446655440000",
        "type": "emotion",
        "title": "情感分析",
        "content": {
          "text_length": 120,
          "primary_emotion": "happy",
          "sentiment_score": 0.82
        },
        "tokens_used": 65,
        "created_at": "2024-12-20T14:20:00.000Z"
      },
      {
        "id": "990e8400-e29b-41d4-a716-446655440000",
        "type": "voice",
        "title": "语音转文字",
        "content": {
          "duration": 15.5,
          "word_count": 32
        },
        "tokens_used": 45,
        "created_at": "2024-12-19T11:30:00.000Z"
      }
    ]
  }
}
```

### 错误响应

#### 400 Bad Request - 参数错误
```json
{
  "success": false,
  "message": "日期格式不正确"
}
```

#### 401 Unauthorized - 未授权
```json
{
  "success": false,
  "message": "未授权，请先登录"
}
```

#### 500 Internal Server Error - 服务器错误
```json
{
  "success": false,
  "message": "获取历史记录失败，请稍后重试"
}
```

---

## 字段说明

### 响应字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| total | Integer | 总记录数 |
| page | Integer | 当前页码 |
| limit | Integer | 每页数量 |
| list | Array | 历史记录列表 |
| id | UUID | 记录ID |
| type | String | 服务类型 |
| title | String | 记录标题 |
| content | Object | 记录内容(不同类型结构不同) |
| tokens_used | Integer | 消耗Token数 |
| created_at | DateTime | 创建时间 |

---

## 业务规则

1. 默认按时间倒序排列
2. content字段内容因type不同而异：
   - chat: 包含user_message和assistant_message
   - story: 包含theme和word_count
   - image: 包含image_url和results
   - emotion: 包含text_length、primary_emotion、sentiment_score
   - voice: 包含duration和word_count
3. 记录保留180天
4. 支持按type筛选
5. 日期范围最大1年

---

## 使用场景

- 查看AI使用记录
- 统计AI使用情况
- 回顾对话内容
- 数据分析和报告
- 用户行为分析

---

## 注意事项

1. content字段为简化内容，完整内容需调用对应详情接口
2. 建议使用分页加载
3. tokens_used用于统计消耗
4. 不同type的content结构不同
5. 记录超过180天会自动删除

---

## Postman测试

### 配置步骤
1. 创建新请求
2. 选择方法：`GET`
3. 输入URL：`http://localhost:3000/api/ai/history`
4. 在Headers中添加：
   - `Authorization`: `Bearer {你的accessToken}`
5. 在Params中添加（可选）：
   - Key: `type`, Value: `chat`
   - Key: `limit`, Value: `20`
6. 点击`Send`发送请求

### 预期结果
- 状态码：200
- 返回AI使用历史记录
- list包含各类型记录
- total显示总数量

---

## 相关接口

- [7.1 AI对话](./7.1-chat.md)
- [7.2 AI生成故事](./7.2-story.md)
- [7.3 图像识别](./7.3-image-recognize.md)
- [7.4 情感分析](./7.4-emotion-analyze.md)
- [7.8 获取AI使用统计](./7.8-get-stats.md)

---

## 更新记录

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2024-12-22 | 初始版本 |

---

**维护者**: AI Assistant
**最后更新**: 2024-12-22

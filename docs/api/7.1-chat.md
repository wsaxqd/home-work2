# API 7.1 - AI对话

## 接口信息

- **接口名称**: AI对话
- **请求方法**: POST
- **请求路径**: `/api/ai/chat`
- **需要认证**: 是

---

## 接口描述

与AI进行智能对话，支持上下文记忆、多轮对话，可用于学习辅导、问答、聊天等场景。

---

## 请求参数

### Header参数
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Content-Type | String | 是 | application/json |
| Authorization | String | 是 | Bearer {accessToken} |

### Body参数
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| message | String | 是 | 用户消息(最大1000字) | "什么是光合作用？" |
| session_id | String | 否 | 会话ID(用于多轮对话) | "session_123" |
| context | Array | 否 | 上下文消息历史 | [] |
| mode | String | 否 | 对话模式(tutor/friend/story，默认tutor) | "tutor" |
| temperature | Float | 否 | 创造性(0-1，默认0.7) | 0.7 |

### 请求示例

```json
{
  "message": "什么是光合作用？",
  "session_id": "session_123",
  "context": [
    {
      "role": "user",
      "content": "你好"
    },
    {
      "role": "assistant",
      "content": "你好！我是你的AI学习助手，有什么可以帮助你的吗？"
    }
  ],
  "mode": "tutor",
  "temperature": 0.7
}
```

---

## 响应结果

### 成功响应 (200 OK)

```json
{
  "success": true,
  "message": "对话成功",
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "session_id": "session_123",
    "user_message": "什么是光合作用？",
    "assistant_message": "光合作用是植物、藻类和某些细菌利用光能，将二氧化碳和水转化为葡萄糖和氧气的过程。这是地球上最重要的化学反应之一...",
    "mode": "tutor",
    "tokens_used": 125,
    "created_at": "2024-12-21T14:30:00.000Z"
  }
}
```

### 错误响应

#### 400 Bad Request - 参数错误
```json
{
  "success": false,
  "message": "消息内容不能为空"
}
```

#### 401 Unauthorized - 未授权
```json
{
  "success": false,
  "message": "未授权，请先登录"
}
```

#### 429 Too Many Requests - 超出限额
```json
{
  "success": false,
  "message": "今日AI对话次数已用完，请明天再试"
}
```

#### 500 Internal Server Error - 服务器错误
```json
{
  "success": false,
  "message": "AI服务暂时不可用，请稍后重试"
}
```

---

## 字段说明

### 响应字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | UUID | 对话记录ID |
| session_id | String | 会话ID |
| user_message | String | 用户消息 |
| assistant_message | String | AI回复 |
| mode | String | 对话模式 |
| tokens_used | Integer | 消耗的Token数 |
| created_at | DateTime | 创建时间 |

---

## 业务规则

1. 每个用户每天有限定的对话次数（如100次）
2. session_id用于维护多轮对话上下文
3. context最多保留最近10轮对话
4. mode=tutor: 教学模式，AI会给予详细解释
5. mode=friend: 朋友模式，AI会更加亲切随和
6. mode=story: 故事模式，AI会以讲故事的方式回答
7. temperature越高，回答越有创造性

---

## 使用场景

- 学习辅导和答疑
- 知识问答
- 聊天陪伴
- 作业辅助
- 兴趣探索

---

## 注意事项

1. 消息内容需过滤敏感词
2. 建议实现打字机效果展示AI回复
3. session_id需在客户端维护
4. 注意控制对话频率，避免滥用
5. 超出限额后应提示用户

---

## Postman测试

### 配置步骤
1. 创建新请求
2. 选择方法：`POST`
3. 输入URL：`http://localhost:3000/api/ai/chat`
4. 在Headers中添加：
   - `Content-Type`: `application/json`
   - `Authorization`: `Bearer {你的accessToken}`
5. 选择Body标签
6. 选择`raw`和`JSON`格式
7. 输入请求体（见上方示例）
8. 点击`Send`发送请求

### 预期结果
- 状态码：200
- 返回AI的回复内容
- session_id用于后续对话

---

## 相关接口

- [7.2 AI生成故事](./7.2-story.md)
- [7.4 情感分析](./7.4-emotion-analyze.md)
- [7.7 获取AI使用历史](./7.7-get-history.md)
- [7.8 获取AI使用统计](./7.8-get-stats.md)

---

## 更新记录

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2024-12-22 | 初始版本 |

---

**维护者**: AI Assistant
**最后更新**: 2024-12-22

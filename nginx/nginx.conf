# ============================================================
# 启蒙之光 - 生产环境 Nginx 配置 (优化版)
# 适用于腾讯云服务器部署
# ============================================================

# 上游后端服务器配置
upstream backend {
    server 127.0.0.1:3000;
    keepalive 64;                    # 增加长连接数，提升性能
    keepalive_timeout 65s;
    keepalive_requests 1000;
}

# HTTP 服务器 - 重定向到 HTTPS
server {
    listen 80;
    listen [::]:80;
    server_name example.com www.example.com;

    # 访问日志（HTTP 重定向日志可关闭以减少 I/O）
    access_log off;

    # Let's Encrypt 证书验证路径
    location ^~ /.well-known/acme-challenge/ {
        default_type "text/plain";
        root /var/www/certbot;
        allow all;
    }

    # 健康检查端点（不重定向，方便监控）
    location = /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # 其他请求重定向到 HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS 服务器
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name example.com www.example.com;

    # ==================== SSL 证书配置 ====================
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    ssl_trusted_certificate /etc/nginx/ssl/chain.pem;

    # SSL 优化配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:50m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    # OCSP Stapling（在线证书状态协议装订）
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 223.5.5.5 223.6.6.6 valid=300s;
    resolver_timeout 5s;

    # SSL 缓冲区优化
    ssl_buffer_size 4k;

    # ==================== 安全头部配置 ====================
    # HSTS（强制 HTTPS）- 有效期 1 年
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # 防止点击劫持
    add_header X-Frame-Options "SAMEORIGIN" always;

    # 防止 MIME 类型嗅探
    add_header X-Content-Type-Options "nosniff" always;

    # XSS 保护
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer 策略
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # 内容安全策略（CSP）- 针对儿童教育平台的严格策略
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https: blob:; media-src 'self' blob:; connect-src 'self' https://api.dify.ai https://open.bigmodel.cn https://api.deepseek.com; frame-ancestors 'self'; base-uri 'self'; form-action 'self';" always;

    # 权限策略（Permissions Policy）- 限制敏感功能访问
    add_header Permissions-Policy "geolocation=(), microphone=(self), camera=(self), payment=(), usb=()" always;

    # ==================== 日志配置 ====================
    access_log /var/log/nginx/qmzg-access.log combined buffer=32k flush=5m;
    error_log /var/log/nginx/qmzg-error.log warn;

    # ==================== 上传与请求限制 ====================
    # 客户端上传限制（根据项目中 10MB 的限制）
    client_max_body_size 10M;
    client_body_buffer_size 128k;
    client_header_buffer_size 4k;
    large_client_header_buffers 4 8k;

    # 超时配置
    client_body_timeout 30s;
    client_header_timeout 30s;
    send_timeout 30s;

    # ==================== Gzip 压缩配置 ====================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1024;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/x-javascript
        application/xml
        application/xml+rss
        application/rss+xml
        application/atom+xml
        application/vnd.ms-fontobject
        application/x-font-ttf
        font/opentype
        font/truetype
        image/svg+xml
        image/x-icon;
    gzip_disable "msie6";

    # ==================== Brotli 压缩配置（可选，需安装模块）====================
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;

    # ==================== 前端静态文件 ====================
    location / {
        root /var/www/my-app/app/dist;
        try_files $uri $uri/ /index.html;

        # HTML 文件不缓存（确保获取最新版本）
        location ~ \.html$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate" always;
            add_header Pragma "no-cache" always;
            add_header Expires "0" always;
            etag off;
        }

        # JS 和 CSS 文件缓存策略（Vite 打包后带 hash）
        location ~* \.(js|css)$ {
            expires 1y;
            add_header Cache-Control "public, immutable" always;
            access_log off;

            # 预压缩文件支持（如果构建时生成了 .gz 文件）
            gzip_static on;
        }

        # 字体文件缓存
        location ~* \.(woff|woff2|ttf|eot|otf)$ {
            expires 1y;
            add_header Cache-Control "public, immutable" always;
            access_log off;

            # CORS 支持（字体文件可能需要）
            add_header Access-Control-Allow-Origin "*" always;
        }

        # 图片文件缓存
        location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|avif)$ {
            expires 1y;
            add_header Cache-Control "public, immutable" always;
            access_log off;
        }

        # JSON 配置文件缓存（如 manifest.json）
        location ~* \.json$ {
            expires 1d;
            add_header Cache-Control "public, max-age=86400" always;
        }

        # 禁用 source map 访问（生产环境安全）
        location ~* \.map$ {
            deny all;
            access_log off;
            log_not_found off;
        }
    }

    # ==================== API 反向代理配置 ====================
    location /api/ {
        # 速率限制（防止 API 滥用）- 每个 IP 每秒 10 个请求
        limit_req zone=api_limit burst=20 nodelay;

        proxy_pass http://backend;
        proxy_http_version 1.1;

        # 代理头部配置
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket 支持（为 PK 对战等实时功能预留）
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # 超时配置（AI 接口可能响应较慢）
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # 缓冲配置
        proxy_buffering on;
        proxy_buffer_size 8k;
        proxy_buffers 32 8k;
        proxy_busy_buffers_size 16k;

        # 错误处理
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 10s;

        # 隐藏后端服务器信息
        proxy_hide_header X-Powered-By;

        # 不缓存 API 响应
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    }

    # ==================== 上传文件访问配置 ====================
    # 禁止直接访问临时上传目录（优先级最高）
    location ^~ /uploads/temp/ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 禁止访问危险文件类型
    location ~ ^/uploads/.*\.(php|sh|py|exe|bat|cmd|html|htm|js)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 上传文件访问
    location /uploads/ {
        alias /var/www/my-app/server/uploads/;

        # 文件缓存策略（用户上传的图片、音频等）
        expires 30d;
        add_header Cache-Control "public, max-age=2592000" always;
        access_log off;

        # 防盗链配置（可选）
        valid_referers none blocked server_names *.example.com;
        if ($invalid_referer) {
            return 403;
        }

        # 内部类型限制（通过 types 指令）
        types {
            image/jpeg jpg jpeg;
            image/png png;
            image/gif gif;
            image/webp webp;
            audio/mpeg mp3;
            audio/wav wav;
            audio/ogg ogg;
            audio/mp4 m4a;
        }
        default_type application/octet-stream;
    }

    # ==================== 健康检查端点 ====================
    location = /health {
        access_log off;
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    location = /api/health {
        access_log off;
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # ==================== 机器人与爬虫管理 ====================
    # robots.txt
    location = /robots.txt {
        access_log off;
        log_not_found off;

        # 如果没有 robots.txt 文件，返回默认规则
        default_type text/plain;
        return 200 "User-agent: *\nDisallow: /api/\nDisallow: /uploads/temp/\n";
    }

    # favicon.ico
    location = /favicon.ico {
        access_log off;
        log_not_found off;
        expires 7d;
    }

    # ==================== 安全配置 ====================
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 禁止访问备份文件
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 阻止常见扫描路径
    location ~* (wp-admin|wp-login|phpmyadmin|admin|xmlrpc\.php) {
        deny all;
        access_log off;
        log_not_found off;
        return 444;
    }
}

# ==================== 全局配置 ====================
# 请将以下配置添加到 /etc/nginx/nginx.conf 的 http 块中

# 连接升级映射（用于 WebSocket）
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# API 速率限制区域定义
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

# 限制并发连接数（每个 IP）
limit_conn_zone $binary_remote_addr zone=addr:10m;

# 隐藏 Nginx 版本号
server_tokens off;

# 文件句柄缓存
open_file_cache max=10000 inactive=60s;
open_file_cache_valid 120s;
open_file_cache_min_uses 2;
open_file_cache_errors on;

# ============================================================
# 启蒙之光 - 开发环境 Nginx 配置 (优化版)
# 适用于本地开发测试
# ============================================================

# WebSocket 连接升级映射
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

# 上游后端服务器配置
upstream backend_dev {
    server 127.0.0.1:3000;
    keepalive 32;
}

# 上游 Vite 开发服务器
upstream vite_dev {
    server 127.0.0.1:5173;
    keepalive 16;
}

server {
    listen 8080;
    server_name localhost 127.0.0.1;

    # ==================== 日志配置 ====================
    access_log logs/qmzg-dev-access.log combined;
    error_log logs/qmzg-dev-error.log debug;

    # ==================== 上传限制 ====================
    client_max_body_size 10M;
    client_body_buffer_size 128k;

    # 开发环境超时配置（较长，方便调试）
    client_body_timeout 120s;
    client_header_timeout 120s;
    send_timeout 120s;
    proxy_read_timeout 120s;

    # ==================== 开发环境安全头部（宽松） ====================
    # CORS 允许所有来源（开发环境）
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH" always;
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;
    add_header Access-Control-Allow-Credentials "true" always;

    # OPTIONS 请求快速响应
    if ($request_method = 'OPTIONS') {
        return 204;
    }

    # 基础安全头部
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    # ==================== 前端 Vite 开发服务器代理 ====================
    location / {
        proxy_pass http://vite_dev;
        proxy_http_version 1.1;

        # WebSocket 支持（Vite HMR 必需）
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 代理头部
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 禁用缓存（开发环境实时更新）
        proxy_cache_bypass $http_upgrade;
        proxy_no_cache 1;
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;

        # 超时配置
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        # 缓冲配置
        proxy_buffering off;
    }

    # ==================== API 代理到后端 ====================
    location /api/ {
        proxy_pass http://backend_dev;
        proxy_http_version 1.1;

        # 代理头部
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支持（预留）
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 超时配置（开发环境较长，方便调试）
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        # 禁用缓冲（实时查看响应）
        proxy_buffering off;

        # 禁用缓存
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;

        # CORS 支持
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH" always;
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization" always;
    }

    # ==================== 上传文件访问 ====================
    location /uploads/ {
        # Windows 路径使用相对路径
        alias ../server/uploads/;

        # 开发环境不缓存，方便测试
        add_header Cache-Control "no-cache" always;

        # 允许跨域访问
        add_header Access-Control-Allow-Origin "*" always;
    }

    # ==================== 健康检查 ====================
    location = /health {
        access_log off;
        proxy_pass http://backend_dev;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    location = /api/health {
        access_log off;
        proxy_pass http://backend_dev;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # ==================== 开发工具支持 ====================
    # Source maps 允许访问（调试需要）
    location ~* \.map$ {
        add_header Cache-Control "no-cache" always;
    }

    # 热更新文件
    location /__vite_hmr {
        proxy_pass http://vite_dev;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }

    # Vite 客户端
    location /@vite/client {
        proxy_pass http://vite_dev;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # Node modules（Vite 开发依赖）
    location /node_modules/ {
        proxy_pass http://vite_dev;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
}

# 启蒙之光 - 部署文档

## 📖 文档概述

本文档提供启蒙之光项目的完整部署指南，包括开发环境、测试环境和生产环境的部署步骤。

**适用版本：** v1.0.0
**最后更新：** 2026-01-14

---

## 📋 目录

1. [系统要求](#系统要求)
2. [部署前准备](#部署前准备)
3. [数据库配置](#数据库配置)
4. [环境变量配置](#环境变量配置)
5. [自动化部署](#自动化部署)
6. [手动部署](#手动部署)
7. [Nginx 配置](#nginx-配置)
8. [PM2 进程管理](#pm2-进程管理)
9. [故障排查](#故障排查)
10. [维护与监控](#维护与监控)

---

## 🖥️ 系统要求

### 最低配置
- **操作系统：** Ubuntu 20.04+ / CentOS 7+ / Windows Server 2019+
- **CPU：** 2 核心
- **内存：** 2GB RAM
- **存储：** 20GB 可用空间
- **Node.js：** v18.0.0 或更高版本
- **PostgreSQL：** v14.0 或更高版本

### 推荐配置
- **CPU：** 4 核心或更高
- **内存：** 4GB RAM 或更高
- **存储：** 50GB SSD
- **带宽：** 10Mbps 或更高

### 软件依赖
```bash
# 必需
- Node.js >= 18.0.0
- npm >= 9.0.0
- PostgreSQL >= 14.0
- Git

# 推荐
- Nginx (用于反向代理)
- PM2 (用于进程管理)
- Redis (用于缓存，可选)
```

---

## 🔧 部署前准备

### 1. 安装 Node.js

#### Ubuntu/Debian
```bash
# 使用 NodeSource 仓库
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

#### CentOS/RHEL
```bash
# 使用 NodeSource 仓库
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# 验证安装
node --version
npm --version
```

#### Windows
下载并安装 Node.js：https://nodejs.org/

### 2. 安装 PostgreSQL

#### Ubuntu/Debian
```bash
# 安装 PostgreSQL
sudo apt update
sudo apt install -y postgresql postgresql-contrib

# 启动服务
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 验证安装
psql --version
```

#### CentOS/RHEL
```bash
# 安装 PostgreSQL
sudo yum install -y postgresql-server postgresql-contrib

# 初始化数据库
sudo postgresql-setup initdb

# 启动服务
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

#### Windows
下载并安装 PostgreSQL：https://www.postgresql.org/download/windows/

### 3. 克隆项目代码

```bash
# 克隆仓库
git clone <your-repository-url> qmzg
cd qmzg

# 查看当前分支
git branch

# 切换到生产分支（如果有）
git checkout main
```

---

## 🗄️ 数据库配置

### 1. 创建数据库用户

```bash
# 切换到 postgres 用户
sudo -u postgres psql

# 在 PostgreSQL 命令行中执行
CREATE USER qmzg_admin WITH PASSWORD 'your_strong_password_here';
CREATE DATABASE qmzg_production OWNER qmzg_admin;
GRANT ALL PRIVILEGES ON DATABASE qmzg_production TO qmzg_admin;

# 退出
\q
```

### 2. 配置 PostgreSQL 访问权限

编辑 `pg_hba.conf` 文件：

```bash
# Ubuntu/Debian
sudo nano /etc/postgresql/14/main/pg_hba.conf

# CentOS/RHEL
sudo nano /var/lib/pgsql/14/data/pg_hba.conf
```

添加以下行（允许本地连接）：
```
# TYPE  DATABASE        USER            ADDRESS                 METHOD
local   qmzg_production qmzg_admin                              md5
host    qmzg_production qmzg_admin      127.0.0.1/32            md5
host    qmzg_production qmzg_admin      ::1/128                 md5
```

重启 PostgreSQL：
```bash
sudo systemctl restart postgresql
```

### 3. 测试数据库连接

```bash
psql -h localhost -U qmzg_admin -d qmzg_production
# 输入密码后应该能成功连接
```

---

## ⚙️ 环境变量配置

### 1. 复制环境变量模板

```bash
cp .env.production.template .env.production
```

### 2. 编辑配置文件

```bash
nano .env.production
```

### 3. 必须修改的配置项

#### 数据库配置
```bash
DB_HOST=localhost
DB_PORT=5432
DB_NAME=qmzg_production
DB_USER=qmzg_admin
DB_PASSWORD=your_strong_password_here  # ⚠️ 必须修改
```

#### JWT 密钥
```bash
# 生成随机密钥
node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"

# 将生成的密钥填入
JWT_SECRET=生成的64字节十六进制字符串  # ⚠️ 必须修改
```

#### CORS 配置
```bash
CORS_ORIGIN=https://your-domain.com  # ⚠️ 改为实际域名
```

#### 邮件配置（如需邮箱验证功能）
```bash
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your-email@gmail.com
EMAIL_PASSWORD=your-app-password  # ⚠️ 必须配置
EMAIL_FROM=启蒙之光 <noreply@your-domain.com>
```

### 4. 验证配置

```bash
# 检查是否还有未修改的占位符
grep "CHANGE_THIS" .env.production
# 应该没有任何输出
```

---

## 🚀 自动化部署

### 使用部署脚本

项目提供了自动化部署脚本 `deploy.sh`，可以一键完成部署。

#### 1. 赋予执行权限

```bash
chmod +x deploy.sh
```

#### 2. 执行部署

```bash
# 部署到生产环境
bash deploy.sh production

# 部署到测试环境
bash deploy.sh staging
```

#### 3. 部署流程

脚本会自动执行以下步骤：
1. ✅ 检查必要的命令（node, npm, git, psql）
2. ✅ 检查环境变量文件
3. ✅ 备份当前版本
4. ✅ 安装依赖
5. ✅ 运行数据库迁移
6. ✅ 构建项目
7. ✅ 运行测试
8. ✅ 停止旧服务
9. ✅ 启动新服务
10. ✅ 健康检查

#### 4. 查看部署日志

```bash
# 查看服务日志
tail -f logs/server.log

# 查看 PM2 日志（如果使用 PM2）
pm2 logs qmzg-server
```

---

## 🔧 手动部署

详细的手动部署步骤请参见：[部署文档-手动部署.md](./部署文档-手动部署.md)

主要步骤包括：
1. 安装依赖
2. 运行数据库迁移
3. 构建项目
4. 启动服务（PM2/systemd/nohup）
5. 验证部署

---

## 🌐 Nginx 配置

详细的 Nginx 配置请参见：[部署文档-Nginx配置.md](./部署文档-Nginx配置.md)

包含：
- Nginx 安装
- 反向代理配置
- SSL 证书配置
- 静态资源优化
- 安全头配置

---

## 🔍 故障排查

详细的故障排查指南请参见：[部署文档-故障排查.md](./部署文档-故障排查.md)

常见问题：
- 数据库连接失败
- JWT Token 无效
- 端口被占用
- Nginx 502 错误
- 邮件发送失败
- 内存不足

---

## 📊 维护与监控

详细的维护监控指南请参见：[部署文档-维护监控.md](./部署文档-维护监控.md)

包含：
- 数据库备份策略
- 日志轮转配置
- 性能监控方案
- 更新部署流程
- 安全维护清单
- 告警配置

---

## 📚 相关文档

- [发布准备清单.md](./发布准备清单.md) - 完整的发布前检查清单
- [.env.production.template](./.env.production.template) - 生产环境配置模板
- [deploy.sh](./deploy.sh) - 自动化部署脚本
- [部署文档-手动部署.md](./部署文档-手动部署.md) - 手动部署详细步骤
- [部署文档-Nginx配置.md](./部署文档-Nginx配置.md) - Nginx 配置指南
- [部署文档-故障排查.md](./部署文档-故障排查.md) - 故障排查手册
- [部署文档-维护监控.md](./部署文档-维护监控.md) - 维护监控指南

---

## ⚠️ 重要提醒

### 部署前必须完成

1. ✅ 修改所有默认密码和密钥
2. ✅ 配置正确的数据库连接
3. ✅ 运行数据库迁移
4. ✅ 测试所有核心功能
5. ✅ 配置 SSL 证书（生产环境）

### 安全检查清单

- [ ] JWT_SECRET 已更换为强密钥
- [ ] 数据库密码已修改
- [ ] CORS_ORIGIN 已设置为实际域名
- [ ] .env 文件不在版本控制中
- [ ] 依赖包已检查安全漏洞
- [ ] 防火墙已正确配置
- [ ] SSL 证书已配置（生产环境）

---

**文档版本：** v1.0.0
**最后更新：** 2026-01-14
**维护者：** 启蒙之光开发团队


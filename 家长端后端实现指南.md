# å®¶é•¿ç«¯åç«¯åŠŸèƒ½å®ç°å®Œæ•´æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [å·²å®ç°çš„åŠŸèƒ½](#å·²å®ç°çš„åŠŸèƒ½)
2. [æ•°æ®åº“ç»“æ„](#æ•°æ®åº“ç»“æ„)
3. [API æ¥å£æ–‡æ¡£](#api-æ¥å£æ–‡æ¡£)
4. [éƒ¨ç½²æ­¥éª¤](#éƒ¨ç½²æ­¥éª¤)
5. [å‰ç«¯é›†æˆç¤ºä¾‹](#å‰ç«¯é›†æˆç¤ºä¾‹)

---

## âœ… å·²å®ç°çš„åŠŸèƒ½

### 1. æ•°æ®åº“è¡¨ç»“æ„
- âœ… `parents` - å®¶é•¿è´¦å·è¡¨
- âœ… `children` - å­©å­ç»‘å®šå…³ç³»è¡¨
- âœ… `usage_logs` - ä½¿ç”¨è®°å½•è¡¨
- âœ… `parental_controls` - å®¶é•¿æ§åˆ¶è®¾ç½®è¡¨

### 2. åç«¯æœåŠ¡
- âœ… `parentAuthService` - å®¶é•¿è®¤è¯æœåŠ¡ï¼ˆæ³¨å†Œã€ç™»å½•ã€JWTï¼‰
- âœ… `childrenService` - å­©å­ç®¡ç†æœåŠ¡
- âœ… `usageDataService` - ä½¿ç”¨æ•°æ®ç»Ÿè®¡æœåŠ¡

### 3. API è·¯ç”±
- âœ… `/api/parent/*` - å®Œæ•´çš„å®¶é•¿ç«¯APIè·¯ç”±

### 4. å‰ç«¯å·¥å…·
- âœ… `parentAPI.ts` - å‰ç«¯APIè°ƒç”¨å·¥å…·

---

## ğŸ“Š æ•°æ®åº“ç»“æ„

### parents è¡¨ï¼ˆå®¶é•¿è´¦å·ï¼‰
```sql
CREATE TABLE parents (
  id SERIAL PRIMARY KEY,
  phone VARCHAR(20) UNIQUE NOT NULL,          -- æ‰‹æœºå·ï¼ˆç™»å½•ç”¨ï¼‰
  password VARCHAR(255) NOT NULL,              -- åŠ å¯†å¯†ç 
  name VARCHAR(100),                           -- å§“å
  email VARCHAR(255),                          -- é‚®ç®±
  avatar VARCHAR(500),                         -- å¤´åƒ
  notification_settings JSONB,                 -- é€šçŸ¥è®¾ç½®
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### children è¡¨ï¼ˆå­©å­ç»‘å®šå…³ç³»ï¼‰
```sql
CREATE TABLE children (
  id SERIAL PRIMARY KEY,
  parent_id INTEGER REFERENCES parents(id),   -- å®¶é•¿ID
  user_id INTEGER REFERENCES users(id),       -- å­©å­ç”¨æˆ·ID
  nickname VARCHAR(100),                      -- æ˜µç§°
  age INTEGER,                                -- å¹´é¾„
  gender VARCHAR(10),                         -- æ€§åˆ«
  grade VARCHAR(50),                          -- å¹´çº§
  avatar VARCHAR(500),                        -- å¤´åƒ
  bind_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### usage_logs è¡¨ï¼ˆä½¿ç”¨è®°å½•ï¼‰
```sql
CREATE TABLE usage_logs (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),      -- ç”¨æˆ·ID
  activity_type VARCHAR(50),                  -- æ´»åŠ¨ç±»å‹ï¼ˆé˜…è¯»/æ¸¸æˆ/åˆ›ä½œ/å­¦ä¹ ï¼‰
  activity_title VARCHAR(255),                -- æ´»åŠ¨æ ‡é¢˜
  duration INTEGER NOT NULL,                  -- æ—¶é•¿ï¼ˆç§’ï¼‰
  score INTEGER,                              -- åˆ†æ•°
  metadata JSONB,                             -- é¢å¤–æ•°æ®
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### parental_controls è¡¨ï¼ˆå®¶é•¿æ§åˆ¶è®¾ç½®ï¼‰
```sql
CREATE TABLE parental_controls (
  id SERIAL PRIMARY KEY,
  user_id INTEGER UNIQUE REFERENCES users(id),  -- å­©å­ç”¨æˆ·ID
  daily_limit INTEGER DEFAULT 120,               -- æ¯æ—¥æ—¶é•¿é™åˆ¶ï¼ˆåˆ†é’Ÿï¼‰
  game_limit INTEGER DEFAULT 30,                 -- æ¸¸æˆæ—¶é•¿é™åˆ¶ï¼ˆåˆ†é’Ÿï¼‰
  start_time TIME DEFAULT '08:00:00',            -- å¯ç”¨å¼€å§‹æ—¶é—´
  end_time TIME DEFAULT '20:00:00',              -- å¯ç”¨ç»“æŸæ—¶é—´
  time_control_enabled BOOLEAN DEFAULT true,     -- æ˜¯å¦å¯ç”¨æ—¶é—´æ§åˆ¶
  content_controls JSONB,                        -- å†…å®¹æ§åˆ¶è®¾ç½®
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## ğŸ”Œ API æ¥å£æ–‡æ¡£

### åŸºç¡€ä¿¡æ¯
- **Base URL**: `http://localhost:3001/api/parent`
- **è®¤è¯æ–¹å¼**: Bearer Tokenï¼ˆJWTï¼‰
- **Header**: `Authorization: Bearer {token}`

### 1. è®¤è¯æ¥å£

#### 1.1 å®¶é•¿æ³¨å†Œ
```http
POST /api/parent/register
Content-Type: application/json

{
  "phone": "13800138000",
  "password": "password123",
  "name": "å¼ å®¶é•¿",
  "email": "parent@example.com",
  "childAccount": "xiaoming"  // å¯é€‰ï¼Œå­©å­çš„ç”¨æˆ·å
}

Response:
{
  "success": true,
  "message": "æ³¨å†ŒæˆåŠŸ",
  "data": {
    "parent": { ... },
    "token": "eyJhbGciOiJIUzI1NiIs..."
  }
}
```

#### 1.2 å®¶é•¿ç™»å½•
```http
POST /api/parent/login
Content-Type: application/json

{
  "phone": "13800138000",
  "password": "password123"
}

Response:
{
  "success": true,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "parent": { ... },
    "token": "eyJhbGciOiJIUzI1NiIs..."
  }
}
```

#### 1.3 è·å–å®¶é•¿ä¿¡æ¯
```http
GET /api/parent/profile
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": {
    "id": 1,
    "phone": "13800138000",
    "name": "å¼ å®¶é•¿",
    "email": "parent@example.com",
    ...
  }
}
```

#### 1.4 æ›´æ–°ä¸ªäººä¿¡æ¯
```http
PUT /api/parent/profile
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "æ–°åå­—",
  "email": "newemail@example.com"
}
```

#### 1.5 ä¿®æ”¹å¯†ç 
```http
POST /api/parent/change-password
Authorization: Bearer {token}
Content-Type: application/json

{
  "oldPassword": "old123",
  "newPassword": "new456"
}
```

#### 1.6 æ›´æ–°é€šçŸ¥è®¾ç½®
```http
PUT /api/parent/notification-settings
Authorization: Bearer {token}
Content-Type: application/json

{
  "learningReminder": true,
  "timeoutWarning": true,
  "achievementNotify": true,
  "weeklyReport": true
}
```

### 2. å­©å­ç®¡ç†æ¥å£

#### 2.1 è·å–æ‰€æœ‰å­©å­
```http
GET /api/parent/children
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": [
    {
      "id": 1,
      "user_id": 10,
      "nickname": "å°æ˜",
      "age": 8,
      "gender": "ç”·",
      "grade": "äºŒå¹´çº§",
      "avatar": "ğŸ‘¦",
      "account": "xiaoming",
      "bind_time": "2024-01-01T00:00:00.000Z"
    }
  ]
}
```

#### 2.2 æ·»åŠ å­©å­
```http
POST /api/parent/children
Authorization: Bearer {token}
Content-Type: application/json

{
  "account": "xiaoming",
  "nickname": "å°æ˜",
  "age": 8,
  "gender": "ç”·",
  "grade": "äºŒå¹´çº§",
  "avatar": "ğŸ‘¦"
}
```

#### 2.3 æ›´æ–°å­©å­ä¿¡æ¯
```http
PUT /api/parent/children/:childId
Authorization: Bearer {token}
Content-Type: application/json

{
  "nickname": "å°æ˜æ˜",
  "age": 9,
  "grade": "ä¸‰å¹´çº§"
}
```

#### 2.4 è§£ç»‘å­©å­
```http
DELETE /api/parent/children/:childId
Authorization: Bearer {token}
```

### 3. ä½¿ç”¨æ•°æ®æ¥å£

#### 3.1 è·å–ä½¿ç”¨ç»Ÿè®¡
```http
GET /api/parent/usage-stats/:userId?startDate=2024-01-01&endDate=2024-01-07
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": {
    "dailyStats": [
      {
        "date": "2024-01-01",
        "learning": 60,
        "gaming": 30
      }
    ],
    "typeStats": [...],
    "recentRecords": [...]
  }
}
```

#### 3.2 è·å–ä»Šæ—¥ä½¿ç”¨æ—¶é•¿
```http
GET /api/parent/today-usage/:userId
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": {
    "total_duration": 90,
    "game_duration": 30,
    "learning_duration": 60
  }
}
```

#### 3.3 è·å–æˆé•¿æŠ¥å‘Š
```http
GET /api/parent/growth-report/:userId?type=week
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": {
    "totalLearning": 368,
    "totalGaming": 178,
    "totalCreation": 125,
    "activeDays": 7,
    "favoriteActivity": "ç»˜æœ¬é˜…è¯»",
    "achievementCount": 5,
    "improvement": 15
  }
}
```

### 4. æ§åˆ¶è®¾ç½®æ¥å£

#### 4.1 è·å–æ§åˆ¶è®¾ç½®
```http
GET /api/parent/control-settings/:userId
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": {
    "dailyLimit": 120,
    "gameLimit": 30,
    "startTime": "08:00:00",
    "endTime": "20:00:00",
    "timeControlEnabled": true,
    "contentControls": {
      "games": true,
      "creation": true,
      "reading": true,
      "aiEncyclopedia": true
    }
  }
}
```

#### 4.2 æ›´æ–°æ§åˆ¶è®¾ç½®
```http
PUT /api/parent/control-settings/:userId
Authorization: Bearer {token}
Content-Type: application/json

{
  "dailyLimit": 150,
  "gameLimit": 40,
  "timeControlEnabled": true
}
```

#### 4.3 æ£€æŸ¥æ—¶é—´é™åˆ¶
```http
GET /api/parent/check-limit/:userId
Authorization: Bearer {token}

Response:
{
  "success": true,
  "data": {
    "allowed": true,
    "remainingTime": 3600,
    "remainingGameTime": 1800
  }
}
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. å®‰è£…ä¾èµ–ï¼ˆå¦‚æœè¿˜æ²¡å®‰è£…ï¼‰
```bash
cd server
npm install
```

### 2. è¿è¡Œæ•°æ®åº“è¿ç§»
```bash
npm run migrate
```

è¿™ä¼šåˆ›å»ºæ‰€æœ‰éœ€è¦çš„æ•°æ®åº“è¡¨ï¼ŒåŒ…æ‹¬æ–°çš„å®¶é•¿ç«¯è¡¨ã€‚

### 3. å¯åŠ¨åç«¯æœåŠ¡å™¨
```bash
npm run dev
```

æœåŠ¡å™¨å°†åœ¨ `http://localhost:3001` å¯åŠ¨ã€‚

### 4. éªŒè¯æœåŠ¡æ˜¯å¦æ­£å¸¸
è®¿é—®: `http://localhost:3001/health`

åº”è¯¥çœ‹åˆ°ï¼š
```json
{
  "success": true,
  "message": "æœåŠ¡è¿è¡Œæ­£å¸¸",
  "timestamp": "2024-01-13T..."
}
```

---

## ğŸ’» å‰ç«¯é›†æˆç¤ºä¾‹

### 1. åœ¨å‰ç«¯é¡µé¢ä¸­å¼•å…¥APIå·¥å…·
```typescript
import parentAPI from '@/services/parentAPI';
```

### 2. ä½¿ç”¨ç¤ºä¾‹

#### å®¶é•¿ç™»å½•
```typescript
// ParentLogin.tsx
const handleLogin = async () => {
  try {
    const result = await parentAPI.login({
      phone: formData.phone,
      password: formData.password
    });

    // Tokenå·²è‡ªåŠ¨ä¿å­˜åˆ°localStorage
    navigate('/parent/dashboard');
  } catch (error) {
    alert(error.message);
  }
};
```

#### è·å–å­©å­åˆ—è¡¨
```typescript
// ChildrenManagement.tsx
useEffect(() => {
  const loadChildren = async () => {
    try {
      const children = await parentAPI.getChildren();
      setChildren(children);
    } catch (error) {
      console.error('åŠ è½½å¤±è´¥:', error);
    }
  };

  loadChildren();
}, []);
```

#### è·å–ä½¿ç”¨ç»Ÿè®¡
```typescript
// LearningData.tsx
useEffect(() => {
  const loadStats = async () => {
    try {
      const stats = await parentAPI.getUsageStats(
        selectedChild.user_id,
        startDate.toISOString(),
        endDate.toISOString()
      );
      setStats(stats);
    } catch (error) {
      console.error('åŠ è½½å¤±è´¥:', error);
    }
  };

  loadStats();
}, [selectedChild, startDate, endDate]);
```

#### æ›´æ–°æ§åˆ¶è®¾ç½®
```typescript
// UsageControl.tsx
const handleSave = async () => {
  try {
    await parentAPI.updateControlSettings(selectedChild.user_id, {
      dailyLimit: timeControl.dailyLimit,
      gameLimit: timeControl.gameLimit,
      startTime: timeControl.startTime,
      endTime: timeControl.endTime,
      timeControlEnabled: timeControl.enabled,
      contentControls: contentControl
    });

    alert('è®¾ç½®ä¿å­˜æˆåŠŸ!');
  } catch (error) {
    alert('ä¿å­˜å¤±è´¥: ' + error.message);
  }
};
```

#### è·å–æˆé•¿æŠ¥å‘Š
```typescript
// GrowthReport.tsx
useEffect(() => {
  const loadReport = async () => {
    try {
      const data = await parentAPI.getGrowthReport(
        selectedChild.user_id,
        reportType  // 'week' æˆ– 'month'
      );
      setReport(data);
    } catch (error) {
      console.error('åŠ è½½å¤±è´¥:', error);
    }
  };

  loadReport();
}, [selectedChild, reportType]);
```

---

## ğŸ”§ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. å®æ—¶æ•°æ®åŒæ­¥
åœ¨å„¿ç«¥ç«¯è®°å½•ä½¿ç”¨æ•°æ®ï¼š
```typescript
// åœ¨å„¿ç«¥ç«¯å„ä¸ªåŠŸèƒ½ä¸­æ·»åŠ 
import { recordUsage } from '@/services/usageTracking';

// æ¸¸æˆç»“æŸæ—¶
await recordUsage({
  activityType: 'æ¸¸æˆ',
  activityTitle: 'æ°´æœæ¶ˆæ¶ˆä¹',
  duration: 180,  // ç§’
  score: 95
});
```

### 2. æ•°æ®å¯è§†åŒ–
å®‰è£…å›¾è¡¨åº“ï¼š
```bash
cd app
npm install recharts
```

ç„¶ååœ¨LearningData.tsxä¸­ä½¿ç”¨ï¼š
```typescript
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend } from 'recharts';

<LineChart width={600} height={300} data={weeklyData}>
  <CartesianGrid strokeDasharray="3 3" />
  <XAxis dataKey="day" />
  <YAxis />
  <Tooltip />
  <Legend />
  <Line type="monotone" dataKey="learning" stroke="#4CAF50" />
  <Line type="monotone" dataKey="gaming" stroke="#FF9800" />
</LineChart>
```

### 3. PDF æŠ¥å‘Šå¯¼å‡º
å®‰è£… jsPDFï¼š
```bash
npm install jspdf
```

åœ¨ GrowthReport.tsx ä¸­ï¼š
```typescript
import jsPDF from 'jspdf';

const handleExportPDF = () => {
  const doc = new jsPDF();
  doc.text('æˆé•¿æŠ¥å‘Š', 10, 10);
  // ... æ·»åŠ æŠ¥å‘Šå†…å®¹
  doc.save('growth-report.pdf');
};
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **JWT_SECRET**: ç”Ÿäº§ç¯å¢ƒä¸­è¯·åœ¨ `.env` æ–‡ä»¶ä¸­è®¾ç½®å¼ºå¯†ç 
2. **CORS**: ç¡®ä¿åç«¯CORSé…ç½®å…è®¸å‰ç«¯åŸŸå
3. **æ•°æ®å¤‡ä»½**: å®šæœŸå¤‡ä»½ PostgreSQL æ•°æ®åº“
4. **é”™è¯¯å¤„ç†**: å‰ç«¯éœ€è¦å®Œå–„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
5. **æƒé™éªŒè¯**: ç¡®ä¿å®¶é•¿åªèƒ½è®¿é—®è‡ªå·±ç»‘å®šçš„å­©å­æ•°æ®

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ çš„å®¶é•¿ç«¯å·²ç»æ‹¥æœ‰å®Œæ•´çš„åç«¯æ”¯æŒï¼š
- âœ… å®Œæ•´çš„æ•°æ®åº“è¡¨ç»“æ„
- âœ… å®‰å…¨çš„è®¤è¯ç³»ç»Ÿï¼ˆJWTï¼‰
- âœ… å®Œå–„çš„APIæ¥å£
- âœ… ä¾¿æ·çš„å‰ç«¯è°ƒç”¨å·¥å…·

å¯ä»¥å¼€å§‹ä½¿ç”¨çœŸå®æ•°æ®äº†ï¼

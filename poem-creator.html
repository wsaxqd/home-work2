<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè¯—è¯åŠ©æ‰‹ - å¯è’™ä¹‹å…‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f4ff 0%, #fff0f5 100%);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 0;
            position: relative;
            min-height: 100vh;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);
            color: white;
            border-radius: 0 0 20px 20px;
        }
        
        .back-button {
            font-size: 24px;
            cursor: pointer;
        }
        
        .page-title {
            font-size: 20px;
            text-align: center;
            flex: 1;
        }
        
        .main-content {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(100vh - 140px);
        }
        
        .section-title {
            font-size: 18px;
            margin: 20px 0 15px;
            color: #9c27b0;
            display: flex;
            align-items: center;
        }
        
        .section-title::before {
            content: "";
            display: inline-block;
            width: 5px;
            height: 20px;
            background: #9c27b0;
            margin-right: 10px;
            border-radius: 3px;
        }
        
        /* è¯—è¯åˆ›ä½œå‘å¯¼æ ·å¼ */
        .wizard-section {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 2px solid #f0f4ff;
        }
        
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
        }
        
        .wizard-steps::before {
            content: "";
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }
        
        .wizard-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }
        
        .step-circle {
            width: 30px;
            height: 30px;
            background: #e0e0e0;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .wizard-step.active .step-circle {
            background: #9c27b0;
        }
        
        .wizard-step.completed .step-circle {
            background: #673ab7;
        }
        
        .step-label {
            font-size: 12px;
            color: #666;
        }
        
        .wizard-step.active .step-label {
            color: #9c27b0;
            font-weight: bold;
        }
        
        .wizard-content {
            min-height: 200px;
        }
        
        /* è¯—è¯ä¸»é¢˜é€‰æ‹©æ ·å¼ */
        .theme-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .theme-card {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid transparent;
        }
        
        .theme-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .theme-card.selected {
            border-color: #9c27b0;
            background: #f0f4ff;
        }
        
        .theme-icon {
            font-size: 30px;
            margin-bottom: 10px;
            color: #9c27b0;
        }
        
        .theme-name {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .theme-desc {
            font-size: 12px;
            color: #666;
        }
        
        /* è¯—è¯é£æ ¼é€‰æ‹©æ ·å¼ */
        .style-section {
            display: none;
        }
        
        .style-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .style-card {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid transparent;
        }
        
        .style-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .style-card.selected {
            border-color: #9c27b0;
            background: #f0f4ff;
        }
        
        .style-icon {
            font-size: 30px;
            margin-bottom: 10px;
            color: #9c27b0;
        }
        
        .style-name {
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .style-desc {
            font-size: 12px;
            color: #666;
        }
        
        /* å…³é”®è¯è®¾ç½®æ ·å¼ */
        .keywords-section {
            display: none;
        }
        
        .keywords-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-size: 14px;
            margin-bottom: 8px;
            color: #333;
        }
        
        .form-input {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
        }
        
        .form-input:focus {
            border-color: #9c27b0;
        }
        
        .form-select {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            background: white;
        }
        
        .keywords-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .keyword-tag {
            background: #e1bee7;
            color: #4a148c;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .remove-keyword {
            cursor: pointer;
            font-weight: bold;
        }
        
        /* è¯—è¯é¢„è§ˆæ ·å¼ */
        .preview-section {
            display: none;
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .preview-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #9c27b0;
            text-align: center;
        }
        
        .poem-preview {
            background: white;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .poem-content {
            font-size: 16px;
            line-height: 1.8;
            color: #333;
            white-space: pre-line;
        }
        
        .poem-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #9c27b0;
        }
        
        .loading-animation {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f0f4ff;
            border-top: 4px solid #9c27b0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        .loading-text {
            font-size: 14px;
            color: #666;
        }
        
        /* è¯—è¯ç¼–è¾‘å™¨æ ·å¼ */
        .editor-section {
            display: none;
        }
        
        .editor-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .toolbar-btn {
            padding: 8px 12px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.3s;
        }
        
        .toolbar-btn:hover {
            background: #e0e0e0;
        }
        
        .editor-area {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            line-height: 1.8;
            resize: vertical;
            outline: none;
            font-family: 'æ¥·ä½“', 'STKaiti', serif;
        }
        
        .editor-area:focus {
            border-color: #9c27b0;
        }
        
        .suggestions-panel {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .suggestions-title {
            font-size: 14px;
            margin-bottom: 10px;
            color: #9c27b0;
        }
        
        .suggestions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .suggestion-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 15px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .suggestion-item:hover {
            background: #e1bee7;
        }
        
        /* æ§åˆ¶æŒ‰é’®æ ·å¼ */
        .control-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, background 0.3s;
        }
        
        .btn:disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #9c27b0;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #7b1fa2;
            transform: scale(1.03);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
            transform: scale(1.03);
        }
        
        /* åº•éƒ¨å¯¼èˆªæ ·å¼ */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 15px 0;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 480px;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        
        .nav-icon {
            font-size: 24px;
            margin-bottom: 5px;
            color: #999;
        }
        
        .nav-item.active .nav-icon {
            color: #9c27b0;
        }
        
        .nav-text {
            font-size: 12px;
            color: #999;
        }
        
        .nav-item.active .nav-text {
            color: #9c27b0;
            font-weight: bold;
        }
        
        /* åŠ¨ç”» */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 480px) {
            .container {
                padding-bottom: 70px;
            }
            
            .theme-grid {
                grid-template-columns: 1fr;
            }
            
            .style-grid {
                grid-template-columns: 1fr;
            }
            
            .control-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="back-button" onclick="goBack()">â†</div>
            <div class="page-title">AIè¯—è¯åŠ©æ‰‹</div>
            <div style="width: 24px;"></div> <!-- å ä½ä¿æŒå¯¹ç§° -->
        </div>
        
        <div class="main-content">
            <div class="wizard-section">
                <div class="wizard-steps">
                    <div class="wizard-step active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">é€‰æ‹©ä¸»é¢˜</div>
                    </div>
                    <div class="wizard-step" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">è¯—è¯é£æ ¼</div>
                    </div>
                    <div class="wizard-step" id="step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">å…³é”®è¯</div>
                    </div>
                    <div class="wizard-step" id="step4">
                        <div class="step-circle">4</div>
                        <div class="step-label">ç”Ÿæˆè¯—è¯</div>
                    </div>
                </div>
                
                <div class="wizard-content">
                    <!-- æ­¥éª¤1: é€‰æ‹©ä¸»é¢˜ -->
                    <div id="step1-content" class="step-content">
                        <div class="section-title">é€‰æ‹©è¯—è¯ä¸»é¢˜</div>
                        <div class="theme-grid">
                            <div class="theme-card" onclick="selectTheme(this, 'nature')">
                                <div class="theme-icon">ğŸŒ³</div>
                                <div class="theme-name">è‡ªç„¶é£å…‰</div>
                                <div class="theme-desc">å±±æ°´èŠ±é¸Ÿï¼Œå››å­£å˜åŒ–</div>
                            </div>
                            <div class="theme-card" onclick="selectTheme(this, 'friendship')">
                                <div class="theme-icon">ğŸ¤</div>
                                <div class="theme-name">å‹è°Šæƒ…æ„Ÿ</div>
                                <div class="theme-desc">æœ‹å‹æƒ…è°Šï¼Œæ¸©æš–å¿ƒé—´</div>
                            </div>
                            <div class="theme-card" onclick="selectTheme(this, 'family')">
                                <div class="theme-icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</div>
                                <div class="theme-name">å®¶åº­æ¸©é¦¨</div>
                                <div class="theme-desc">äº²æƒ…æ¸©æš–ï¼Œå®¶çš„æ„Ÿè§‰</div>
                            </div>
                            <div class="theme-card" onclick="selectTheme(this, 'dream')">
                                <div class="theme-icon">âœ¨</div>
                                <div class="theme-name">æ¢¦æƒ³æœªæ¥</div>
                                <div class="theme-desc">å¿ƒä¸­æ¢¦æƒ³ï¼Œæœªæ¥å±•æœ›</div>
                            </div>
                            <div class="theme-card" onclick="selectTheme(this, 'seasons')">
                                <div class="theme-icon">ğŸ‚</div>
                                <div class="theme-name">å››å­£å˜åŒ–</div>
                                <div class="theme-desc">æ˜¥å¤ç§‹å†¬ï¼Œå­£èŠ‚æ›´æ›¿</div>
                            </div>
                            <div class="theme-card" onclick="selectTheme(this, 'custom')">
                                <div class="theme-icon">ğŸ¯</div>
                                <div class="theme-name">è‡ªå®šä¹‰</div>
                                <div class="theme-desc">è‡ªç”±å‘æŒ¥ï¼Œéšå¿ƒåˆ›ä½œ</div>
                            </div>
                        </div>
                        
                        <div class="control-buttons">
                            <button class="btn btn-secondary" onclick="goBack()">è¿”å›</button>
                            <button class="btn btn-primary" id="step1-next" onclick="nextStep(2)" disabled>ä¸‹ä¸€æ­¥</button>
                        </div>
                    </div>
                    
                    <!-- æ­¥éª¤2: é€‰æ‹©è¯—è¯é£æ ¼ -->
                    <div id="step2-content" class="step-content style-section">
                        <div class="section-title">é€‰æ‹©è¯—è¯é£æ ¼</div>
                        <div class="style-grid">
                            <div class="style-card" onclick="selectStyle(this, 'ancient')">
                                <div class="style-icon">ğŸ“œ</div>
                                <div class="style-name">å¤å…¸è¯—è¯</div>
                                <div class="style-desc">ä¼ ç»ŸéŸµå¾‹ï¼Œå¤é£é›…è‡´</div>
                            </div>
                            <div class="style-card" onclick="selectStyle(this, 'modern')">
                                <div class="style-icon">ğŸ–‹ï¸</div>
                                <div class="style-name">ç°ä»£è¯—æ­Œ</div>
                                <div class="style-desc">è‡ªç”±è¡¨è¾¾ï¼Œæƒ…æ„ŸçœŸæŒš</div>
                            </div>
                            <div class="style-card" onclick="selectStyle(this, 'children')">
                                <div class="style-icon">ğŸ§’</div>
                                <div class="style-name">ç«¥è°£å„¿æ­Œ</div>
                                <div class="style-desc">æ´»æ³¼å¯çˆ±ï¼Œæœ—æœ—ä¸Šå£</div>
                            </div>
                            <div class="style-card" onclick="selectStyle(this, 'haiku')">
                                <div class="style-icon">ğŸŒ</div>
                                <div class="style-name">ä¿³å¥çŸ­è¯—</div>
                                <div class="style-desc">ç®€æ´ç²¾ç‚¼ï¼Œæ„å¢ƒæ·±è¿œ</div>
                            </div>
                            <div class="style-card" onclick="selectStyle(this, 'funny')">
                                <div class="style-icon">ğŸ˜„</div>
                                <div class="style-name">å¹½é»˜è¯™è°</div>
                                <div class="style-desc">è½»æ¾æœ‰è¶£ï¼Œé€—äººå‘ç¬‘</div>
                            </div>
                            <div class="style-card" onclick="selectStyle(this, 'custom')">
                                <div class="style-icon">ğŸ¨</div>
                                <div class="style-name">è‡ªç”±é£æ ¼</div>
                                <div class="style-desc">ä¸æ‹˜ä¸€æ ¼ï¼Œéšå¿ƒåˆ›ä½œ</div>
                            </div>
                        </div>
                        
                        <div class="control-buttons">
                            <button class="btn btn-secondary" onclick="prevStep(1)">ä¸Šä¸€æ­¥</button>
                            <button class="btn btn-primary" id="step2-next" onclick="nextStep(3)" disabled>ä¸‹ä¸€æ­¥</button>
                        </div>
                    </div>
                    
                    <!-- æ­¥éª¤3: è®¾ç½®å…³é”®è¯ -->
                    <div id="step3-content" class="step-content keywords-section">
                        <div class="section-title">è®¾ç½®è¯—è¯å…³é”®è¯</div>
                        <div class="keywords-form">
                            <div class="form-group">
                                <label class="form-label">ä¸»è¦å…³é”®è¯</label>
                                <input type="text" class="form-input" id="main-keyword" placeholder="ä¾‹å¦‚ï¼šæ˜¥å¤©ã€å‹è°Šã€æ¢¦æƒ³..." onkeypress="addKeywordOnEnter(event)">
                                <div class="keywords-tags" id="keywords-tags"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">æƒ…æ„ŸåŸºè°ƒ</label>
                                <select class="form-select" id="emotion-tone" onchange="updatePoemData()">
                                    <option value="happy">å¿«ä¹å–œæ‚¦</option>
                                    <option value="calm">å¹³é™å®‰å®</option>
                                    <option value="nostalgic">æ€€å¿µæ€å¿µ</option>
                                    <option value="inspiring">æ¿€åŠ±é¼“èˆ</option>
                                    <option value="funny">å¹½é»˜æœ‰è¶£</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">è¯—è¯é•¿åº¦</label>
                                <select class="form-select" id="poem-length" onchange="updatePoemData()">
                                    <option value="short">çŸ­è¯— (4-8è¡Œ)</option>
                                    <option value="medium" selected>ä¸­ç­‰ (8-12è¡Œ)</option>
                                    <option value="long">é•¿è¯— (12-16è¡Œ)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="control-buttons">
                            <button class="btn btn-secondary" onclick="prevStep(2)">ä¸Šä¸€æ­¥</button>
                            <button class="btn btn-primary" id="step3-next" onclick="nextStep(4)">ç”Ÿæˆè¯—è¯</button>
                        </div>
                    </div>
                    
                    <!-- æ­¥éª¤4: ç”Ÿæˆè¯—è¯ -->
                    <div id="step4-content" class="step-content preview-section">
                        <div class="section-title">AIä¸ºä½ åˆ›ä½œçš„è¯—è¯</div>
                        <div class="preview-title" id="poem-title">ä½ çš„ä¸“å±è¯—è¯</div>
                        
                        <div class="poem-preview">
                            <div class="loading-animation" id="loading-animation">
                                <div class="spinner"></div>
                                <div class="loading-text">AIæ­£åœ¨åˆ›ä½œä½ çš„è¯—è¯ï¼Œè¯·ç¨å€™...</div>
                            </div>
                            <div class="poem-content" id="generated-poem" style="display: none;">
                                <div class="poem-title" id="display-poem-title"></div>
                                <div id="display-poem-content"></div>
                            </div>
                        </div>
                        
                        <div class="control-buttons">
                            <button class="btn btn-secondary" onclick="prevStep(3)">é‡æ–°ç”Ÿæˆ</button>
                            <button class="btn btn-primary" id="step4-next" onclick="nextStep(5)">ç¼–è¾‘å®Œå–„</button>
                        </div>
                    </div>
                    
                    <!-- æ­¥éª¤5: ç¼–è¾‘å®Œå–„ -->
                    <div id="step5-content" class="step-content editor-section">
                        <div class="section-title">ç¼–è¾‘å’Œå®Œå–„ä½ çš„è¯—è¯</div>
                        
                        <div class="editor-toolbar">
                            <button class="toolbar-btn" onclick="suggestRhymes()">ğŸµ æŠ¼éŸµå»ºè®®</button>
                            <button class="toolbar-btn" onclick="suggestWords()">ğŸ’¡ è¯æ±‡å»ºè®®</button>
                            <button class="toolbar-btn" onclick="improveStructure()">ğŸ“ ç»“æ„ä¼˜åŒ–</button>
                            <button class="toolbar-btn" onclick="addEmotion()">â¤ï¸ å¢å¼ºæƒ…æ„Ÿ</button>
                        </div>
                        
                        <textarea class="editor-area" id="poem-editor" placeholder="åœ¨è¿™é‡Œç¼–è¾‘å’Œå®Œå–„ä½ çš„è¯—è¯..."></textarea>
                        
                        <div class="suggestions-panel" id="suggestions-panel" style="display: none;">
                            <div class="suggestions-title">AIå»ºè®®</div>
                            <div class="suggestions-list" id="suggestions-list"></div>
                        </div>
                        
                        <div class="control-buttons">
                            <button class="btn btn-secondary" onclick="prevStep(4)">ä¸Šä¸€æ­¥</button>
                            <button class="btn btn-primary" onclick="savePoem()">ä¿å­˜è¯—è¯</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bottom-nav">
            <div class="nav-item" onclick="navigateTo('index.html')">
                <div class="nav-icon">ğŸ </div>
                <div class="nav-text">é¦–é¡µ</div>
            </div>
            <div class="nav-item" onclick="navigateTo('explore.html')">
                <div class="nav-icon">ğŸ”</div>
                <div class="nav-text">æ¢ç´¢</div>
            </div>
            <div class="nav-item" onclick="navigateTo('create.html')">
                <div class="nav-icon">ğŸ¨</div>
                <div class="nav-text">åˆ›ä½œ</div>
            </div>
            <div class="nav-item" onclick="navigateTo('mind-garden.html')">
                <div class="nav-icon">ğŸ’</div>
                <div class="nav-text">å¿ƒçµ</div>
            </div>
            <div class="nav-item" onclick="navigateTo('profile.html')">
                <div class="nav-icon">ğŸ‘¤</div>
                <div class="nav-text">æˆ‘çš„</div>
            </div>
        </div>
    </div>

    <script src="navigation-template.js"></script>
    <script>
        // APIé…ç½®
        const API_BASE = 'http://localhost:3000/api';

        // åˆå§‹åŒ–å¯¼èˆª
        document.addEventListener('DOMContentLoaded', function() {
            initAppNavigation();
        });

        // å½“å‰æ­¥éª¤å’Œè¯—è¯æ•°æ®
        let currentStep = 1;
        let poemData = {
            theme: '',
            style: '',
            keywords: [],
            emotion: 'happy',
            length: 'medium',
            poemContent: '',
            poemTitle: ''
        };
        
        // å¯¼èˆªåŠŸèƒ½
        function goBack() {
            // ç‰¹æ®Šå¤„ç†ï¼šåœ¨éç¬¬ä¸€æ­¥æ—¶è¿”å›ä¸Šä¸€æ­¥
            if (currentStep > 1) {
                prevStep(currentStep - 1);
                return;
            }
            
            // æ ‡å‡†å¯¼èˆªé€»è¾‘
            if (!document.referrer || window.history.length <= 1) {
                navigateTo('index.html');
            } else {
                window.history.back();
            }
        }
        
        // æ­¥éª¤å¯¼èˆª
        function nextStep(step) {
            // éšè—å½“å‰æ­¥éª¤å†…å®¹
            document.getElementById(`step${currentStep}-content`).style.display = 'none';
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${currentStep}`).classList.add('completed');
            
            // æ˜¾ç¤ºæ–°æ­¥éª¤å†…å®¹
            currentStep = step;
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById(`step${currentStep}-content`).style.display = 'block';
            
            // ç‰¹æ®Šå¤„ç†ï¼šæ­¥éª¤4ç”Ÿæˆè¯—è¯
            if (step === 4) {
                generatePoem();
            }
            
            // ç‰¹æ®Šå¤„ç†ï¼šæ­¥éª¤5åŠ è½½è¯—è¯åˆ°ç¼–è¾‘å™¨
            if (step === 5) {
                document.getElementById('poem-editor').value = poemData.poemContent;
            }
        }
        
        function prevStep(step) {
            // éšè—å½“å‰æ­¥éª¤å†…å®¹
            document.getElementById(`step${currentStep}-content`).style.display = 'none';
            
            // æ›´æ–°æ­¥éª¤æŒ‡ç¤ºå™¨
            document.getElementById(`step${currentStep}`).classList.remove('active');
            
            // æ˜¾ç¤ºä¸Šä¸€æ­¥å†…å®¹
            currentStep = step;
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById(`step${currentStep}-content`).style.display = 'block';
            
            // ç‰¹æ®Šå¤„ç†ï¼šè¿”å›æ­¥éª¤3æ—¶é‡ç½®å…³é”®è¯
            if (step === 3) {
                updateKeywordsDisplay();
            }
        }
        
        // é€‰æ‹©ä¸»é¢˜
        function selectTheme(caller, theme) {
            // æ”¯æŒä¸¤ç§è°ƒç”¨ï¼šselectTheme(theme) æˆ– selectTheme(caller, theme)
            if (typeof theme === 'undefined') {
                theme = caller;
                caller = null;
            }

            // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('selected');
            });

            // è®¾ç½®æ–°çš„é€‰æ‹©
            var targetEl = null;
            if (caller && caller.nodeType) {
                targetEl = caller;
            } else if (typeof event !== 'undefined' && event.target) {
                targetEl = event.target.closest ? event.target.closest('.theme-card') : event.target;
            }

            if (targetEl) targetEl.classList.add('selected');
            poemData.theme = theme;

            // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
            document.getElementById('step1-next').disabled = false;
        }

        // é€‰æ‹©é£æ ¼
        function selectStyle(caller, style) {
            // æ”¯æŒä¸¤ç§è°ƒç”¨ï¼šselectStyle(style) æˆ– selectStyle(caller, style)
            if (typeof style === 'undefined') {
                style = caller;
                caller = null;
            }

            // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.style-card').forEach(card => {
                card.classList.remove('selected');
            });

            // è®¾ç½®æ–°çš„é€‰æ‹©
            var targetEl = null;
            if (caller && caller.nodeType) {
                targetEl = caller;
            } else if (typeof event !== 'undefined' && event.target) {
                targetEl = event.target.closest ? event.target.closest('.style-card') : event.target;
            }

            if (targetEl) targetEl.classList.add('selected');
            poemData.style = style;

            // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
            document.getElementById('step2-next').disabled = false;
        }
        
        // æ·»åŠ å…³é”®è¯
        function addKeywordOnEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('main-keyword');
                const keyword = input.value.trim();
                
                if (keyword && !poemData.keywords.includes(keyword)) {
                    poemData.keywords.push(keyword);
                    input.value = '';
                    updateKeywordsDisplay();
                }
            }
        }
        
        // æ›´æ–°å…³é”®è¯æ˜¾ç¤º
        function updateKeywordsDisplay() {
            const tagsContainer = document.getElementById('keywords-tags');
            tagsContainer.innerHTML = '';
            
            poemData.keywords.forEach((keyword, index) => {
                const tag = document.createElement('div');
                tag.className = 'keyword-tag';
                tag.innerHTML = `${keyword} <span class="remove-keyword" onclick="removeKeyword(${index})">Ã—</span>`;
                tagsContainer.appendChild(tag);
            });
            
            // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®ï¼ˆå¦‚æœæœ‰è‡³å°‘ä¸€ä¸ªå…³é”®è¯ï¼‰
            document.getElementById('step3-next').disabled = poemData.keywords.length === 0;
        }
        
        // ç§»é™¤å…³é”®è¯
        function removeKeyword(index) {
            poemData.keywords.splice(index, 1);
            updateKeywordsDisplay();
        }
        
        // æ›´æ–°è¯—è¯æ•°æ®
        function updatePoemData() {
            poemData.emotion = document.getElementById('emotion-tone').value;
            poemData.length = document.getElementById('poem-length').value;
        }
        
        // ç”Ÿæˆè¯—è¯
        async function generatePoem() {
            const loadingElement = document.getElementById('loading-animation');
            const poemElement = document.getElementById('generated-poem');

            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            loadingElement.style.display = 'flex';
            poemElement.style.display = 'none';

            try {
                // æ£€æŸ¥JWT token
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('è¯·å…ˆç™»å½•ï¼');
                    window.location.href = 'login.html';
                    return;
                }

                // æ„å»ºè¯—è¯ç”Ÿæˆè¯·æ±‚
                const themes = {
                    'nature': 'è‡ªç„¶é£å…‰',
                    'friendship': 'å‹è°Šæƒ…æ„Ÿ',
                    'family': 'å®¶åº­æ¸©é¦¨',
                    'dream': 'æ¢¦æƒ³æœªæ¥',
                    'seasons': 'å››å­£å˜åŒ–',
                    'custom': 'è‡ªç”±åˆ›ä½œ'
                };

                const styles = {
                    'ancient': 'å¤å…¸',
                    'modern': 'ç°ä»£',
                    'children': 'ç«¥è°£',
                    'haiku': 'ä¿³å¥',
                    'funny': 'å¹½é»˜',
                    'custom': 'è‡ªç”±'
                };

                const emotions = {
                    'happy': 'å¿«ä¹',
                    'calm': 'å¹³é™',
                    'nostalgic': 'æ€€å¿µ',
                    'inspiring': 'æ¿€åŠ±',
                    'funny': 'å¹½é»˜'
                };

                const themeName = themes[poemData.theme] || 'è‡ªç”±';
                const styleName = styles[poemData.style] || 'è‡ªç”±';
                const emotionName = emotions[poemData.emotion] || 'å¿«ä¹';

                const keywordsStr = poemData.keywords.length > 0 ? poemData.keywords.join('ã€') : '';

                const prompt = `è¯·ä¸ºå„¿ç«¥åˆ›ä½œä¸€é¦–${styleName}é£æ ¼çš„${themeName}ä¸»é¢˜è¯—æ­Œã€‚

è¯—æ­Œè¦æ±‚ï¼š
1. é£æ ¼ï¼š${styleName}
2. ä¸»é¢˜ï¼š${themeName}
3. æƒ…æ„Ÿï¼š${emotionName}
${keywordsStr ? '4. å…³é”®è¯ï¼š' + keywordsStr : ''}

åˆ›ä½œè¦æ±‚ï¼š
- é€‚åˆ6-12å²å„¿ç«¥é˜…è¯»
- è¯­è¨€ä¼˜ç¾ã€å¯Œæœ‰æƒ³è±¡åŠ›
- å†…å®¹ç§¯æå‘ä¸Šï¼Œä¼ é€’æ­£èƒ½é‡
- ${poemData.style === 'haiku' ? 'ç¬¦åˆä¿³å¥æ ¼å¼ï¼ˆ5-7-5éŸ³èŠ‚ï¼‰' : ''}
- ${poemData.style === 'ancient' ? 'å¯ä»¥ä½¿ç”¨ç®€å•çš„å¤å…¸è¯—è¯éŸµå¾‹' : ''}
- ${poemData.style === 'children' ? 'è¦æœ—æœ—ä¸Šå£ï¼Œé€‚åˆå„¿ç«¥ä¼ å”±' : ''}
- ç¯‡å¹…é€‚ä¸­ï¼ˆ${poemData.length === 'short' ? 'ç®€çŸ­' : poemData.length === 'medium' ? 'é€‚ä¸­' : 'è¾ƒé•¿'}ï¼‰`;

                // è°ƒç”¨AI APIç”Ÿæˆè¯—è¯
                const response = await fetch(`${API_BASE}/ai/story`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        context: `å„¿ç«¥è¯—æ­Œåˆ›ä½œ - ${themeName}Â·${styleName}`
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.message || 'è¯—æ­Œç”Ÿæˆå¤±è´¥');
                }

                // è·å–AIç”Ÿæˆçš„è¯—æ­Œ
                const generatedPoem = result.data.response || result.data.reply || result.data.poem;

                if (!generatedPoem) {
                    throw new Error('AIè¿”å›çš„è¯—æ­Œå†…å®¹ä¸ºç©º');
                }

                // æå–æ ‡é¢˜å’Œå†…å®¹
                const lines = generatedPoem.split('\n').filter(line => line.trim());
                let title = `${themeName}Â·${styleName}è¯—`;
                let content = generatedPoem;

                // å¦‚æœç¬¬ä¸€è¡Œçœ‹èµ·æ¥åƒæ ‡é¢˜ï¼Œåˆ™æå–å®ƒ
                if (lines.length > 0 && lines[0].length < 30 && !lines[0].includes('ã€‚')) {
                    title = lines[0].trim();
                    content = lines.slice(1).join('\n').trim();
                }

                // æ˜¾ç¤ºç”Ÿæˆçš„è¯—è¯
                loadingElement.style.display = 'none';
                poemElement.style.display = 'block';
                document.getElementById('display-poem-title').textContent = title;
                document.getElementById('display-poem-content').textContent = content;

                // ä¿å­˜è¯—è¯å†…å®¹
                poemData.poemTitle = title;
                poemData.poemContent = `${title}\n\n${content}`;

                // å¯ç”¨ä¸‹ä¸€æ­¥æŒ‰é’®
                document.getElementById('step4-next').disabled = false;

            } catch (error) {
                console.error('ç”Ÿæˆè¯—è¯å¤±è´¥:', error);

                // éšè—åŠ è½½åŠ¨ç”»
                loadingElement.style.display = 'none';

                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                poemElement.style.display = 'block';
                document.getElementById('display-poem-title').textContent = 'ç”Ÿæˆå¤±è´¥';
                document.getElementById('display-poem-content').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e57373;">
                        <p style="font-size: 40px; margin-bottom: 10px;">ğŸ˜”</p>
                        <p style="font-size: 16px; margin-bottom: 10px;">è¯—æ­Œç”Ÿæˆå¤±è´¥</p>
                        <p style="font-size: 14px; color: #666;">${error.message}</p>
                        <button class="btn btn-primary" onclick="generatePoem()" style="margin-top: 15px;">é‡æ–°ç”Ÿæˆ</button>
                    </div>
                `;
            }
        }
        // æŠ¼éŸµå»ºè®®
        function suggestRhymes() {
            const suggestions = ['æ˜æœˆ-åŸé‡', 'èŠ±å¼€-æ˜¥æ¥', 'é£ç¿”-æ¢¦æƒ³', 'æœ‹å‹-é•¿ä¹…', 'å®¶åº­-æ¸©é¦¨'];
            showSuggestions(suggestions, 'æŠ¼éŸµè¯å¯¹');
        }
        
        // è¯æ±‡å»ºè®®
        function suggestWords() {
            const suggestions = ['ç’€ç’¨', 'ç»šçƒ‚', 'æ‚ æ‰¬', 'çµåŠ¨', 'èŠ¬èŠ³', 'æ˜åªš', 'æ¬¢ç•…'];
            showSuggestions(suggestions, 'ä¼˜ç¾è¯æ±‡');
        }
        
        // ç»“æ„ä¼˜åŒ–
        function improveStructure() {
            const suggestions = ['å¢åŠ å¯¹ä»—', 'è°ƒæ•´å¥å¼', 'å¢å¼ºèŠ‚å¥', 'ä¸°å¯Œæ„è±¡', 'æ·±åŒ–ä¸»é¢˜'];
            showSuggestions(suggestions, 'ç»“æ„å»ºè®®');
        }
        
        // å¢å¼ºæƒ…æ„Ÿ
        function addEmotion() {
            const suggestions = ['åŠ å…¥æ¯”å–»', 'ä½¿ç”¨æ‹Ÿäºº', 'å¢å¼ºç”»é¢æ„Ÿ', 'æ·±åŒ–æƒ…æ„Ÿè¡¨è¾¾', 'å¢åŠ æƒ³è±¡ç©ºé—´'];
            showSuggestions(suggestions, 'æƒ…æ„Ÿå¢å¼º');
        }
        
        // æ˜¾ç¤ºå»ºè®®
        function showSuggestions(suggestions, title) {
            const panel = document.getElementById('suggestions-panel');
            const list = document.getElementById('suggestions-list');
            
            list.innerHTML = '';
            suggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = suggestion;
                item.onclick = function() {
                    insertSuggestion(suggestion);
                };
                list.appendChild(item);
            });
            
            document.querySelector('.suggestions-title').textContent = title + ' - ç‚¹å‡»ä½¿ç”¨';
            panel.style.display = 'block';
        }
        
        // æ’å…¥å»ºè®®
        function insertSuggestion(suggestion) {
            const editor = document.getElementById('poem-editor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            
            editor.value = editor.value.substring(0, start) + suggestion + editor.value.substring(end);
            editor.focus();
            editor.setSelectionRange(start + suggestion.length, start + suggestion.length);
            
            // éšè—å»ºè®®é¢æ¿
            document.getElementById('suggestions-panel').style.display = 'none';
        }
        
        // ä¿å­˜è¯—è¯
        async function savePoem() {
            // æ›´æ–°è¯—è¯å†…å®¹
            const poemContent = document.getElementById('poem-editor').value;

            if (!poemContent || poemContent.trim() === '') {
                alert('è¯—è¯å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            try {
                // æ£€æŸ¥JWT token
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('è¯·å…ˆç™»å½•ï¼');
                    window.location.href = 'login.html';
                    return;
                }

                // æ˜¾ç¤ºä¿å­˜ä¸­æç¤º
                const saveBtn = event.target;
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'ä¿å­˜ä¸­...';
                saveBtn.disabled = true;

                // æå–æ ‡é¢˜
                let poemTitle = poemData.poemTitle || 'æˆ‘çš„è¯—è¯';
                const firstLine = poemContent.split('\n')[0];
                if (firstLine && firstLine.trim().length > 0 && firstLine.trim().length < 50) {
                    poemTitle = firstLine.trim();
                }

                // å‡†å¤‡ä½œå“æ•°æ®
                const workData = {
                    type: 'poem',
                    title: poemTitle,
                    content: poemContent,
                    metadata: {
                        theme: poemData.theme,
                        style: poemData.style,
                        emotion: poemData.emotion,
                        length: poemData.length,
                        keywords: poemData.keywords
                    }
                };

                // è°ƒç”¨åç«¯APIä¿å­˜ä½œå“
                const response = await fetch(`${API_BASE}/works`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(workData)
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.message || 'ä¿å­˜å¤±è´¥');
                }

                // åŒæ—¶ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
                try {
                    const timestamp = new Date().getTime();
                    const dateStr = new Date().toLocaleDateString('zh-CN').replace(/\//g, '-');

                    const poemDataSave = {
                        id: result.data?.id || timestamp,
                        title: poemTitle,
                        filename: `${poemTitle}_${dateStr}_${timestamp}`,
                        content: poemContent,
                        style: poemData.style || 'general',
                        theme: poemData.theme || '',
                        emotion: poemData.emotion || '',
                        keywords: poemData.keywords || [],
                        lineCount: poemContent.split('\n').filter(line => line.trim().length > 0).length,
                        timestamp: new Date().toISOString(),
                        type: 'poem'
                    };

                    let artworks = JSON.parse(localStorage.getItem('qmzg_artworks') || '[]');
                    artworks.unshift(poemDataSave);

                    if (artworks.length > 20) {
                        artworks = artworks.slice(0, 20);
                    }

                    localStorage.setItem('qmzg_artworks', JSON.stringify(artworks));
                } catch (storageError) {
                    console.warn('localStorageä¿å­˜å¤±è´¥:', storageError);
                    // ä¸å½±å“ä¸»è¦æµç¨‹
                }

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;

                alert("è¯—è¯å·²æˆåŠŸä¿å­˜ï¼ä½ å¯ä»¥åœ¨'æˆ‘çš„ä½œå“'ä¸­æŸ¥çœ‹å’Œåˆ†äº«å®ƒã€‚");

                // è¿”å›åˆ›ä½œé¡µ
                setTimeout(() => {
                    navigateTo('create.html');
                }, 1500);

            } catch (error) {
                console.error('ä¿å­˜è¯—è¯å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (event && event.target) {
                    event.target.textContent = 'ä¿å­˜è¯—è¯';
                    event.target.disabled = false;
                }
            }
        }
        
        // ä¸ºåº•éƒ¨å¯¼èˆªæ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.nav-item').forEach((item) => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€æ­¥
            document.getElementById('step1-content').style.display = 'block';
        });
    </script>
</body>
</html>
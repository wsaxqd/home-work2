# Dify AI 平台配置指南

本指南将帮助你配置 Dify AI 平台，让启蒙之光应用的 AI 功能正常工作。

## 📋 配置步骤概览

1. 注册 Dify 账号
2. 创建聊天应用
3. 创建故事生成应用
4. 创建情感分析应用
5. 获取 API 密钥
6. 更新项目配置

---

## 第一步：注册 Dify 账号

### 1.1 访问 Dify 官网

打开浏览器，访问：**https://dify.ai/**

或者使用 Dify 云服务：**https://cloud.dify.ai/**

### 1.2 注册账号

- 点击右上角 "Sign Up" 或 "注册" 按钮
- 可以使用以下方式注册：
  - 邮箱注册
  - GitHub 账号登录
  - Google 账号登录

### 1.3 验证邮箱

如果使用邮箱注册，需要验证邮箱地址。

---

## 第二步：创建聊天应用

### 2.1 进入工作区

登录后，进入你的工作区（Workspace）。

### 2.2 创建新应用

1. 点击 "创建应用" 或 "Create App" 按钮
2. 选择应用类型：**聊天助手（Chat Assistant）**
3. 填写应用信息：
   - **应用名称**：启蒙之光-AI助手
   - **应用描述**：儿童情感陪伴AI助手
   - **应用图标**：可选择一个可爱的图标

### 2.3 配置聊天助手

在应用配置页面：

1. **选择模型**：
   - 推荐使用：GPT-3.5-turbo 或 GPT-4（如果有额度）
   - 国内用户可选择：文心一言、通义千问等

2. **设置系统提示词**：

```
你是一个温暖、友善的AI助手，名叫"小启"。你的任务是陪伴6-12岁的儿童，提供情感支持和鼓励。

你的特点：
- 使用简单、易懂的语言
- 充满耐心和爱心
- 善于倾听和理解孩子的情绪
- 给予积极的鼓励和建议
- 避免使用复杂的词汇和概念

回复要求：
- 每次回复控制在2-3句话
- 使用温暖、友好的语气
- 适当使用表情符号增加亲和力
- 关注孩子的情绪和感受
```

3. **保存并发布应用**

### 2.4 获取聊天应用 API 密钥

1. 在应用详情页，找到 "API 访问" 或 "API Access" 选项
2. 点击 "创建 API 密钥" 或 "Create API Key"
3. 复制生成的 API 密钥（格式类似：`app-xxxxxxxxxxxxxx`）
4. **重要**：妥善保存这个密钥，后面配置时需要用到

---

## 第三步：创建故事生成应用

### 3.1 创建新应用

1. 返回工作区，再次点击 "创建应用"
2. 选择应用类型：**文本生成（Text Generator）**
3. 填写应用信息：
   - **应用名称**：启蒙之光-故事生成器
   - **应用描述**：为儿童生成有趣的故事

### 3.2 配置故事生成器

1. **选择模型**：GPT-3.5-turbo 或其他文本生成模型

2. **设置提示词模板**：

```
请根据以下主题为6-12岁的儿童创作一个有趣的故事：

主题：{{prompt}}
风格：{{style}}
长度：{{length}}

要求：
- 故事要有教育意义
- 语言简单易懂
- 情节生动有趣
- 传递正能量
- 适合儿童阅读

请直接输出故事内容，包含标题。
```

3. **添加变量**：
   - `prompt`（必填）：故事主题
   - `style`（可选）：故事风格
   - `length`（可选）：故事长度

4. **保存并发布**

### 3.3 获取故事生成 API 密钥

同样的方式获取并保存 API 密钥。

---

## 第四步：创建情感分析应用

### 4.1 创建新应用

1. 创建新应用，选择：**文本生成（Text Generator）**
2. 填写应用信息：
   - **应用名称**：启蒙之光-情感分析
   - **应用描述**：分析儿童的情感状态并给予建议

### 4.2 配置情感分析器

1. **设置提示词模板**：

```
请分析以下文本中表达的情感，并给出温暖的回应建议：

文本内容：{{text}}

请以 JSON 格式返回：
{
  "emotion": "情感类型（happy/sad/angry/worried/excited/calm）",
  "confidence": 0.95,
  "suggestions": ["建议1", "建议2"]
}

要求：
- 准确识别情感
- 给出适合儿童的温暖建议
- 建议要具体、可行
```

2. **添加变量**：
   - `text`（必填）：待分析的文本

3. **保存并发布**

### 4.3 获取情感分析 API 密钥

获取并保存 API 密钥。

---

## 第五步：更新项目配置

现在你应该有 3 个 API 密钥：
1. 聊天应用密钥
2. 故事生成应用密钥
3. 情感分析应用密钥

### 5.1 打开 .env 文件

在项目的 `server` 目录下，找到 `.env` 文件并打开。

### 5.2 更新配置信息

将以下配置项替换为你的实际值：

```env
# Dify AI 配置
DIFY_API_URL=https://api.dify.ai/v1
DIFY_CHAT_APP_KEY=app-xxxxxxxxxxxxxx        # 替换为你的聊天应用密钥
DIFY_STORY_APP_KEY=app-xxxxxxxxxxxxxx       # 替换为你的故事生成应用密钥
DIFY_EMOTION_APP_KEY=app-xxxxxxxxxxxxxx     # 替换为你的情感分析应用密钥
```

**注意事项**：
- 如果使用 Dify 云服务，API URL 保持为 `https://api.dify.ai/v1`
- 如果使用自部署的 Dify，需要修改为你的服务器地址
- 密钥格式通常是 `app-` 开头的字符串

### 5.3 保存文件

保存 `.env` 文件后，配置就完成了。

---

## 第六步：重启服务并测试

### 6.1 重启后端服务

配置更新后，需要重启后端服务：

1. 如果服务正在运行，按 `Ctrl + C` 停止
2. 重新启动服务：
   ```bash
   cd server
   npm run dev
   ```

### 6.2 测试 AI 聊天功能

打开浏览器访问：`http://localhost:5174`

1. 进入 "AI情感陪伴" 页面
2. 尝试发送消息，例如："你好"
3. 如果配置正确，AI 会用真实的智能回复响应你

### 6.3 验证配置是否成功

**成功的标志**：
- ✅ AI 回复内容丰富、自然
- ✅ 回复速度较快（通常 1-3 秒）
- ✅ 服务器日志没有 401 错误
- ✅ 不再显示 "使用模拟回复功能" 日志

**如果仍然使用模拟回复**：
- ❌ 检查 API 密钥是否正确复制
- ❌ 确认 Dify 应用已发布
- ❌ 查看服务器日志中的错误信息

---

## 常见问题解答

### Q1: 注册 Dify 需要付费吗？

**A**: Dify 提供免费试用额度。新用户通常会获得一定的免费调用次数。如果需要更多额度，可以购买付费套餐。

### Q2: 可以使用其他 AI 服务吗？

**A**: 可以！项目支持集成其他 AI 服务，如：
- 百度文心一言
- 讯飞星火
- 阿里通义千问
- OpenAI GPT

如需集成其他服务，需要修改 `server/src/services/difyAdapter.ts` 文件。

### Q3: API 密钥泄露了怎么办？

**A**:
1. 立即在 Dify 控制台删除泄露的密钥
2. 创建新的 API 密钥
3. 更新项目配置文件
4. 重启服务

### Q4: 为什么 AI 回复很慢？

**A**: 可能的原因：
- 网络延迟
- Dify 服务器负载高
- 选择的模型响应较慢

建议：使用 GPT-3.5-turbo 等响应较快的模型。

### Q5: 如何查看 API 调用次数？

**A**: 在 Dify 控制台的应用详情页，可以查看：
- API 调用次数统计
- 剩余额度
- 调用历史记录

---

## 技术支持

如果在配置过程中遇到问题：

1. **查看服务器日志**：日志会显示详细的错误信息
2. **检查网络连接**：确保能访问 Dify API
3. **参考 Dify 官方文档**：https://docs.dify.ai/
4. **使用模拟回复**：配置前可以先使用模拟回复测试功能

---

## 总结

完成以上步骤后，你的启蒙之光应用就拥有了真正的 AI 智能对话能力！

**配置清单**：
- ✅ 注册 Dify 账号
- ✅ 创建 3 个应用（聊天、故事、情感分析）
- ✅ 获取 3 个 API 密钥
- ✅ 更新 .env 配置文件
- ✅ 重启服务并测试

祝你使用愉快！🎉

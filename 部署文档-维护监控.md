## ğŸ“Š ç»´æŠ¤ä¸ç›‘æ§

### æ—¥å¸¸ç»´æŠ¤ä»»åŠ¡

#### 1. æ•°æ®åº“å¤‡ä»½

**è‡ªåŠ¨å¤‡ä»½è„šæœ¬ï¼š**
```bash
#!/bin/bash
# backup-db.sh

BACKUP_DIR="/path/to/backups/db"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="qmzg_production"
DB_USER="qmzg_admin"

mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
pg_dump -h localhost -U $DB_USER $DB_NAME | gzip > $BACKUP_DIR/qmzg_$DATE.sql.gz

# åˆ é™¤ 30 å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "qmzg_*.sql.gz" -mtime +30 -delete

echo "æ•°æ®åº“å¤‡ä»½å®Œæˆ: qmzg_$DATE.sql.gz"
```

**è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼š**
```bash
# ç¼–è¾‘ crontab
crontab -e

# æ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½
0 2 * * * /path/to/backup-db.sh >> /path/to/logs/backup.log 2>&1
```

---

#### 2. æ—¥å¿—è½®è½¬

åˆ›å»º `/etc/logrotate.d/qmzg`ï¼š
```
/path/to/qmzg/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        pm2 reloadLogs
    endscript
}
```

---

#### 3. ç›‘æ§æœåŠ¡çŠ¶æ€

**å¥åº·æ£€æŸ¥è„šæœ¬ï¼š**
```bash
#!/bin/bash
# health-check.sh

HEALTH_URL="http://localhost:3000/health"
ALERT_EMAIL="admin@your-domain.com"

if ! curl -f -s $HEALTH_URL > /dev/null; then
    echo "æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼" | mail -s "å¯è’™ä¹‹å…‰æœåŠ¡å‘Šè­¦" $ALERT_EMAIL
    pm2 restart qmzg-server
fi
```

**è®¾ç½®å®šæ—¶æ£€æŸ¥ï¼š**
```bash
# æ¯ 5 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
*/5 * * * * /path/to/health-check.sh
```

---

### æ€§èƒ½ç›‘æ§

#### 1. ä½¿ç”¨ PM2 ç›‘æ§

```bash
# å®æ—¶ç›‘æ§
pm2 monit

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
pm2 show qmzg-server

# æŸ¥çœ‹èµ„æºä½¿ç”¨
pm2 list
```

#### 2. æ•°æ®åº“æ€§èƒ½ç›‘æ§

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT query, calls, total_time, mean_time
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

---

### æ›´æ–°éƒ¨ç½²

#### 1. é›¶åœæœºæ›´æ–°

```bash
#!/bin/bash
# update.sh

echo "å¼€å§‹æ›´æ–°..."

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# å®‰è£…ä¾èµ–
cd server && npm ci && cd ..
cd app && npm ci && cd ..

# è¿è¡Œè¿ç§»
cd server && npm run migrate && cd ..

# æ„å»ºé¡¹ç›®
cd server && npm run build && cd ..
cd app && npm run build && cd ..

# é‡å¯æœåŠ¡ï¼ˆPM2 ä¼šè‡ªåŠ¨å®ç°é›¶åœæœºï¼‰
pm2 reload qmzg-server

echo "æ›´æ–°å®Œæˆï¼"
```

#### 2. å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬

```bash
# æŸ¥çœ‹å¤‡ä»½
ls -lh backups/

# æ¢å¤å¤‡ä»½
BACKUP_DATE="20260114_020000"
cd server
rm -rf dist
cp -r ../backups/$BACKUP_DATE/server_dist dist

cd ../app
rm -rf dist
cp -r ../backups/$BACKUP_DATE/app_dist dist

# é‡å¯æœåŠ¡
pm2 restart qmzg-server
```

---

### å®‰å…¨ç»´æŠ¤

#### 1. å®šæœŸæ›´æ–°ä¾èµ–

```bash
# æ£€æŸ¥è¿‡æœŸä¾èµ–
cd server && npm outdated
cd ../app && npm outdated

# æ›´æ–°ä¾èµ–
npm update

# æ£€æŸ¥å®‰å…¨æ¼æ´
npm audit
npm audit fix
```

#### 2. SSL è¯ä¹¦ç»­æœŸ

```bash
# æµ‹è¯•ç»­æœŸ
sudo certbot renew --dry-run

# æ‰‹åŠ¨ç»­æœŸ
sudo certbot renew

# æŸ¥çœ‹è¯ä¹¦æœ‰æ•ˆæœŸ
sudo certbot certificates
```

#### 3. å®šæœŸæ£€æŸ¥æ—¥å¿—

```bash
# æ£€æŸ¥é”™è¯¯æ—¥å¿—
grep -i error logs/server.log | tail -n 50

# æ£€æŸ¥å¼‚å¸¸ç™»å½•
grep "ç™»å½•å¤±è´¥" logs/server.log | tail -n 20
```

---

### ç›‘æ§æŒ‡æ ‡

#### å…³é”®æŒ‡æ ‡

1. **æœåŠ¡å¯ç”¨æ€§**
   - ç›®æ ‡ï¼š99.9% ä»¥ä¸Š
   - ç›‘æ§ï¼šå¥åº·æ£€æŸ¥ç«¯ç‚¹

2. **å“åº”æ—¶é—´**
   - ç›®æ ‡ï¼šAPI å“åº” < 200ms
   - ç›‘æ§ï¼šNginx è®¿é—®æ—¥å¿—

3. **æ•°æ®åº“è¿æ¥**
   - ç›®æ ‡ï¼šè¿æ¥æ± ä½¿ç”¨ç‡ < 80%
   - ç›‘æ§ï¼šPostgreSQL ç»Ÿè®¡ä¿¡æ¯

4. **å†…å­˜ä½¿ç”¨**
   - ç›®æ ‡ï¼š< 80%
   - ç›‘æ§ï¼šPM2 ç›‘æ§

5. **ç£ç›˜ç©ºé—´**
   - ç›®æ ‡ï¼šå¯ç”¨ç©ºé—´ > 20%
   - ç›‘æ§ï¼šç³»ç»Ÿå‘½ä»¤

---

### å‘Šè­¦é…ç½®

#### 1. é‚®ä»¶å‘Šè­¦

å®‰è£… mailutilsï¼š
```bash
sudo apt install -y mailutils
```

é…ç½®å‘Šè­¦è„šæœ¬ï¼š
```bash
#!/bin/bash
# alert.sh

ALERT_EMAIL="admin@your-domain.com"

# æ£€æŸ¥ç£ç›˜ç©ºé—´
DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "ç£ç›˜ä½¿ç”¨ç‡: $DISK_USAGE%" | mail -s "ç£ç›˜ç©ºé—´å‘Šè­¦" $ALERT_EMAIL
fi

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
MEM_USAGE=$(free | grep Mem | awk '{print int($3/$2 * 100)}')
if [ $MEM_USAGE -gt 80 ]; then
    echo "å†…å­˜ä½¿ç”¨ç‡: $MEM_USAGE%" | mail -s "å†…å­˜ä½¿ç”¨å‘Šè­¦" $ALERT_EMAIL
fi
```

---

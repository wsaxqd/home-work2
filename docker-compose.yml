# ============================================================
# Docker Compose 生产环境配置
# 项目：qmzg (启蒙之光)
# 用途：生产部署，优化性能、安全性、可靠性
# ============================================================

version: '3.8'

services:
  # ==================== PostgreSQL 数据库 ====================
  postgres:
    image: postgres:15-alpine
    container_name: qmzg-postgres
    restart: always

    # 环境变量（生产环境应使用 secrets）
    environment:
      POSTGRES_DB: ${DB_NAME:-qmzg}
      POSTGRES_USER: ${DB_USER:-admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:?请设置数据库密码}
      # 性能优化
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
      # 共享缓冲区（根据服务器内存调整）
      POSTGRES_SHARED_BUFFERS: "256MB"
      POSTGRES_EFFECTIVE_CACHE_SIZE: "1GB"

    # 仅内部网络访问（不暴露端口）
    expose:
      - "5432"

    # 数据持久化
    volumes:
      - postgres-data:/var/lib/postgresql/data
      # 备份脚本（可选）
      # - ./backups:/backups

    # 健康检查
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-admin} -d ${DB_NAME:-qmzg}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

    # 网络
    networks:
      - backend

  # ==================== 后端服务（生产模式） ====================
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
      target: production  # 使用生产环境阶段
      args:
        NODE_VERSION: 18-alpine

    image: qmzg-server:latest
    container_name: qmzg-server
    restart: always

    # 环境变量
    environment:
      NODE_ENV: production
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-qmzg}
      DB_USER: ${DB_USER:-admin}
      DB_PASSWORD: ${DB_PASSWORD:?请设置数据库密码}
      JWT_SECRET: ${JWT_SECRET:?请设置JWT密钥}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:?请设置JWT刷新密钥}
      DIFY_API_URL: ${DIFY_API_URL}
      DIFY_CHAT_APP_KEY: ${DIFY_CHAT_APP_KEY}
      DIFY_STORY_APP_KEY: ${DIFY_STORY_APP_KEY}
      DIFY_EMOTION_APP_KEY: ${DIFY_EMOTION_APP_KEY}
      PORT: 3000

    # 仅内部网络访问
    expose:
      - "3000"

    # 数据持久化
    volumes:
      - uploads-data:/app/uploads

    # 依赖服务
    depends_on:
      postgres:
        condition: service_healthy

    # 健康检查
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      # 副本数（可扩展）
      replicas: 1

    # 网络
    networks:
      - backend
      - frontend

  # ==================== 前端应用（生产模式 - Nginx） ====================
  app:
    build:
      context: ./app
      dockerfile: Dockerfile
      target: production  # 使用生产环境阶段

    image: qmzg-app:latest
    container_name: qmzg-app
    restart: always

    # 仅内部网络访问
    expose:
      - "80"

    # 依赖服务
    depends_on:
      - server

    # 健康检查
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

    # 网络
    networks:
      - frontend

  # ==================== Nginx 反向代理（统一入口） ====================
  nginx-proxy:
    image: nginx:alpine
    container_name: qmzg-nginx-proxy
    restart: always

    # 对外暴露端口
    ports:
      - "80:80"
      - "443:443"  # HTTPS（需配置证书）

    # 配置文件和静态资源
    volumes:
      - ./nginx-proxy.conf:/etc/nginx/conf.d/default.conf:ro
      - ./:/usr/share/nginx/static:ro  # 静态 HTML 文件
      # SSL 证书（HTTPS）
      # - ./ssl/cert.pem:/etc/nginx/ssl/cert.pem:ro
      # - ./ssl/key.pem:/etc/nginx/ssl/key.pem:ro

    # 依赖服务
    depends_on:
      - app
      - server

    # 健康检查
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M

    # 网络
    networks:
      - frontend
      - backend

  # ==================== Redis 缓存（可选） ====================
  # redis:
  #   image: redis:7-alpine
  #   container_name: qmzg-redis
  #   restart: always
  #
  #   command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
  #
  #   expose:
  #     - "6379"
  #
  #   volumes:
  #     - redis-data:/data
  #
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #
  #   networks:
  #     - backend

# ==================== 网络配置 ====================
networks:
  # 前端网络（app + nginx）
  frontend:
    driver: bridge
    name: qmzg-frontend

  # 后端网络（server + postgres + redis）
  backend:
    driver: bridge
    name: qmzg-backend
    # 网络隔离配置
    internal: false

# ==================== 数据卷配置 ====================
volumes:
  # PostgreSQL 数据
  postgres-data:
    name: qmzg-postgres-data
    driver: local

  # 上传文件
  uploads-data:
    name: qmzg-uploads-data
    driver: local

  # Redis 数据（可选）
  # redis-data:
  #   name: qmzg-redis-data
  #   driver: local

# ============================================================
# 生产环境使用方法：
#
# 1. 配置环境变量（创建 .env 文件）：
#    DB_NAME=qmzg
#    DB_USER=admin
#    DB_PASSWORD=your-strong-password
#    JWT_SECRET=your-jwt-secret
#    JWT_REFRESH_SECRET=your-refresh-secret
#    DIFY_API_URL=http://your-dify-url/v1
#    DIFY_CHAT_APP_KEY=app-xxx
#
# 2. 构建并启动：
#    docker-compose up -d --build
#
# 3. 查看日志：
#    docker-compose logs -f
#
# 4. 停止服务：
#    docker-compose down
#
# 5. 数据备份：
#    docker exec qmzg-postgres pg_dump -U admin qmzg > backup.sql
#
# 6. 监控资源：
#    docker stats
#
# 7. 扩容后端服务：
#    docker-compose up -d --scale server=3
#
# 访问：
#   - 应用入口: http://your-domain
#   - API 端点: http://your-domain/api
# ============================================================

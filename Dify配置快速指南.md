# Dify AI 配置 - 快速操作指南

> 创建时间: 2026-01-19
> 优先级: 🔴 P0
> 预估时间: 1-2小时

---

## 🎯 配置目标

将项目的AI功能从模拟数据切换到真实的Dify AI服务,实现:
- ✅ AI智能对话
- ✅ 故事生成
- ✅ 情感分析

---

## 📋 快速配置步骤

### 第一步: 注册Dify账号 (5分钟)

**1. 访问Dify云服务**
```
网址: https://cloud.dify.ai/
```

**2. 注册账号**
- 方式1: 邮箱注册 (推荐)
- 方式2: GitHub登录
- 方式3: Google登录

**3. 验证邮箱** (如果使用邮箱注册)

---

### 第二步: 创建3个应用 (30-40分钟)

你需要创建以下3个应用:

#### 应用1: AI聊天助手 ✅

**创建步骤:**
1. 点击 "创建应用" → 选择 "**聊天助手 (Chat Assistant)**"
2. 填写信息:
   - 名称: `启蒙之光-AI助手`
   - 描述: `儿童情感陪伴AI助手`
   - 图标: 选择一个可爱的图标

3. 配置应用:
   - **模型选择**: GPT-3.5-turbo (推荐) 或其他可用模型
   - **系统提示词**: 复制以下内容

```
你是一个温暖、友善的AI助手，名叫"小启"。你的任务是陪伴6-12岁的儿童，提供情感支持和鼓励。

你的特点：
- 使用简单、易懂的语言
- 充满耐心和爱心
- 善于倾听和理解孩子的情绪
- 给予积极的鼓励和建议
- 避免使用复杂的词汇和概念

回复要求：
- 每次回复控制在2-3句话
- 使用温暖、友好的语气
- 适当使用表情符号增加亲和力
- 关注孩子的情绪和感受
```

4. **保存并发布**
5. **获取API密钥**:
   - 进入应用详情 → "API访问" → "创建API密钥"
   - 复制密钥 (格式: `app-xxxxxxxx`)
   - 保存到记事本备用

---

#### 应用2: 故事生成器 ✅

**创建步骤:**
1. 创建应用 → 选择 "**文本生成 (Text Generator)**"
2. 填写信息:
   - 名称: `启蒙之光-故事生成器`
   - 描述: `为儿童生成有趣的故事`

3. 配置应用:
   - **模型**: GPT-3.5-turbo
   - **提示词模板**: 复制以下内容

```
请根据以下信息为6-12岁的儿童创作一个有趣的故事：

主题：{{theme}}
主角：{{character}}
地点：{{location}}
风格：{{style}}

要求：
- 故事要有教育意义
- 语言简单易懂
- 情节生动有趣
- 传递正能量
- 适合儿童阅读
- 字数在500-1000字之间

请直接输出故事内容，包含标题。
```

4. **添加变量**:
   - `theme` (必填): 故事主题
   - `character` (必填): 主角名字
   - `location` (必填): 故事地点
   - `style` (可选): 故事风格

5. **保存并发布**
6. **获取API密钥** 并保存

---

#### 应用3: 情感分析器 ✅

**创建步骤:**
1. 创建应用 → 选择 "**文本生成 (Text Generator)**"
2. 填写信息:
   - 名称: `启蒙之光-情感分析`
   - 描述: `分析儿童情感并提供建议`

3. 配置应用:
   - **模型**: GPT-3.5-turbo
   - **提示词**: 复制以下内容

```
请分析以下文本中表达的情感，并给出温暖的回应建议：

文本内容：{{text}}

请以 JSON 格式返回：
{
  "emotion": "情感类型（happy/sad/angry/worried/excited/calm）",
  "confidence": 0.95,
  "suggestions": ["建议1", "建议2", "建议3"]
}

要求：
- 准确识别儿童的情感
- 给出适合6-12岁儿童的温暖建议
- 建议要具体、可行、积极向上
```

4. **添加变量**:
   - `text` (必填): 待分析的文本

5. **保存并发布**
6. **获取API密钥** 并保存

---

### 第三步: 更新项目配置 (5分钟)

现在你应该有**3个API密钥**:
1. 聊天助手密钥: `app-xxxxxxxxx`
2. 故事生成密钥: `app-yyyyyyyyy`
3. 情感分析密钥: `app-zzzzzzzzz`

**更新.env配置:**

我已经为你准备好了配置模板,请按照以下步骤操作:

1. 打开 `server/.env` 文件
2. 找到 Dify 配置部分
3. 将你的API密钥填入对应位置:

```env
# AI 服务提供商选择
AI_PROVIDER=dify

# Dify AI配置
DIFY_API_URL=https://api.dify.ai/v1
DIFY_CHAT_APP_KEY=app-你的聊天助手密钥        # 替换这里
DIFY_STORY_APP_KEY=app-你的故事生成密钥       # 替换这里
DIFY_EMOTION_APP_KEY=app-你的情感分析密钥     # 替换这里
DIFY_TIMEOUT=30000
```

4. 保存文件

---

### 第四步: 验证配置 (5分钟)

**使用验证脚本自动检查:**

```bash
cd server
node scripts/check-dify-config.js
```

**手动测试:**

1. 重启后端服务:
```bash
cd server
npm run dev
```

2. 打开浏览器访问: `http://localhost:5174`

3. 进入 "AI情感陪伴" 页面

4. 发送消息: "你好"

5. 检查返回:
   - ✅ **成功**: AI返回智能、自然的回复
   - ❌ **失败**: 返回固定的模拟回复

---

## ✅ 配置检查清单

### 必须完成的项目:

- [ ] 已注册Dify账号
- [ ] 已创建"聊天助手"应用
- [ ] 已创建"故事生成器"应用
- [ ] 已创建"情感分析器"应用
- [ ] 已获取3个API密钥
- [ ] 已更新.env配置文件
- [ ] 已设置 `AI_PROVIDER=dify`
- [ ] 已重启后端服务
- [ ] AI对话功能测试通过

---

## 🔍 验收标准

### 成功的标志:

**1. AI聊天功能**
- ✅ 发送 "你好" 收到个性化回复
- ✅ 回复内容丰富、自然
- ✅ 符合儿童对话风格
- ✅ 响应速度 < 3秒

**2. 故事生成功能**
- ✅ 生成的故事完整、有趣
- ✅ 包含标题和正文
- ✅ 字数符合要求
- ✅ 内容健康向上

**3. 情感分析功能**
- ✅ 能识别情感类型
- ✅ 返回JSON格式
- ✅ 建议具体可行

**4. 系统日志**
- ✅ 无 "使用模拟回复" 提示
- ✅ 无401认证错误
- ✅ 无网络连接错误

---

## ❌ 常见问题排查

### 问题1: API返回401错误

**原因**: API密钥不正确

**解决**:
1. 检查密钥是否完整复制 (包含 `app-` 前缀)
2. 确认Dify应用已发布
3. 尝试重新生成API密钥

### 问题2: 仍然返回模拟回复

**原因**: 配置未生效或未设置AI_PROVIDER

**解决**:
1. 确认 `.env` 中 `AI_PROVIDER=dify`
2. 检查 `DIFY_CHAT_APP_KEY` 等配置是否正确
3. 重启服务 (必须重启才能加载新配置)

### 问题3: 响应很慢或超时

**原因**: 网络问题或模型选择

**解决**:
1. 检查网络连接
2. 尝试切换更快的模型 (如GPT-3.5-turbo)
3. 增加 `DIFY_TIMEOUT` 值

### 问题4: Dify应用创建失败

**原因**: 账号额度不足或权限问题

**解决**:
1. 检查Dify账号是否有可用额度
2. 确认账号已验证
3. 联系Dify支持

---

## 💡 最佳实践

### 1. 密钥管理
- ✅ 不要将密钥提交到Git
- ✅ 使用环境变量管理
- ✅ 定期轮换密钥
- ✅ 监控API调用量

### 2. 成本控制
- ✅ 设置每日调用上限
- ✅ 使用较便宜的模型 (GPT-3.5)
- ✅ 监控API使用情况
- ✅ 合理设置缓存策略

### 3. 性能优化
- ✅ 使用流式返回 (Streaming)
- ✅ 设置合理的超时时间
- ✅ 缓存常见问答
- ✅ 异步处理长耗时请求

### 4. 安全建议
- ✅ 验证用户输入
- ✅ 过滤敏感内容
- ✅ 限制调用频率
- ✅ 记录所有API调用

---

## 📊 费用说明

### Dify免费额度

新用户通常获得:
- ✅ 免费试用额度
- ✅ 有限的API调用次数
- ✅ 部分模型免费使用

### 付费套餐 (可选)

如果免费额度用完:
- 按调用次数计费
- 按token数量计费
- 月度订阅套餐

**建议**: 开始时使用免费额度,测试功能稳定后再考虑升级

---

## 🎯 配置完成后的下一步

完成Dify配置后,你可以:

1. **测试所有AI功能**
   - AI对话
   - 故事生成
   - 诗歌创作
   - 情感分析

2. **继续完善其他功能**
   - 短信验证码
   - 邮件服务
   - 图像识别

3. **优化用户体验**
   - 调整提示词
   - 优化响应速度
   - 添加错误处理

---

## 📞 获取帮助

如果配置过程中遇到问题:

1. **查看日志**:
   ```bash
   cd server
   npm run dev
   # 查看控制台输出
   ```

2. **使用验证脚本**:
   ```bash
   node scripts/check-dify-config.js
   ```

3. **查看Dify文档**: https://docs.dify.ai/

4. **联系技术支持**: support@dify.ai

---

## 📝 配置记录表

请在完成每一步后打勾:

**账号注册**
- [ ] 已访问 https://cloud.dify.ai/
- [ ] 已注册账号
- [ ] 已验证邮箱

**应用创建**
- [ ] 已创建聊天助手应用
- [ ] 已创建故事生成器应用
- [ ] 已创建情感分析器应用
- [ ] 3个应用都已发布

**API密钥**
- [ ] 已获取聊天助手密钥: `app-________`
- [ ] 已获取故事生成密钥: `app-________`
- [ ] 已获取情感分析密钥: `app-________`

**配置更新**
- [ ] 已更新 `AI_PROVIDER=dify`
- [ ] 已更新 `DIFY_CHAT_APP_KEY`
- [ ] 已更新 `DIFY_STORY_APP_KEY`
- [ ] 已更新 `DIFY_EMOTION_APP_KEY`
- [ ] 已保存.env文件

**测试验证**
- [ ] 已重启后端服务
- [ ] AI聊天功能正常
- [ ] 故事生成功能正常
- [ ] 情感分析功能正常

---

**配置完成时间**: __________
**验证通过时间**: __________
**配置人员**: __________

---

祝配置顺利! 🎉 如有问题随时查看本指南或运行验证脚本。
